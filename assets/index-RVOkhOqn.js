import{r as D,c as z,o as tt,w as ie,d as ge,n as Ce,a as A,b as M,e as G,f as ae,h as r,i as Ue,t as X,F as ye,j as it,k as Ye,l as Le,m as Wt,p as ve,q as ut,s as nt,v as ot,u as at,x as jt,y as se,T as Yt,z as Be,A as ht,B as qt}from"./vue-vendor-ByxISuez.js";import{g as Qt,W as Xt}from"./webtorrent-vendor-CGfIxFQu.js";import{r as Zt,v as st,a as en}from"./crypto-vendor-Dm_qpXHR.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();var tn=Zt();const ue=Qt(tn),{floor:nn,random:on}=Math,De="Trystero",$e=(o,e)=>Array(o).fill().map(e),St="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",Vt=o=>$e(o,()=>St[nn(on()*St.length)]).join(""),Me=Vt(20),we=Promise.all.bind(Promise),Dt=typeof window<"u",{entries:ft,fromEntries:$t,keys:an}=Object,fe=()=>{},me=o=>new Error(`${De}: ${o}`),sn=new TextEncoder,rn=new TextDecoder,Te=o=>sn.encode(o),qe=o=>rn.decode(o),Ke=(...o)=>o.join("@"),ln=(o,e,t,n)=>(o.relayUrls||e).slice(0,o.relayUrls?o.relayUrls.length:o.relayRedundancy||t),Oe=JSON.stringify,Ne=JSON.parse,wt=3333,He={};let Ve=null,mt=null;const cn=()=>{Ve||(Ve=new Promise(o=>{mt=o}).finally(()=>{mt=null,Ve=null}))},dn=()=>mt?.(),un=(o,e)=>{const t={},n=()=>{const a=new WebSocket(o);a.onclose=()=>{if(Ve){Ve.then(n);return}He[o]??=wt,setTimeout(n,He[o]),He[o]*=2},a.onmessage=s=>e(s.data),t.socket=a,t.url=a.url,t.ready=new Promise(s=>a.onopen=()=>{s(t),He[o]=wt}),t.send=s=>{a.readyState===1&&a.send(s)}};return n(),t},fn=()=>{if(Dt){const o=new AbortController;return addEventListener("online",dn,{signal:o.signal}),addEventListener("offline",cn,{signal:o.signal}),()=>o.abort()}return fe},yt="AES-GCM",mn={},vn=o=>btoa(String.fromCharCode.apply(null,new Uint8Array(o))),yn=o=>{const e=atob(o);return new Uint8Array(e.length).map((t,n)=>e.charCodeAt(n)).buffer},gn=async(o,e)=>new Uint8Array(await crypto.subtle.digest(o,Te(e))),_e=async o=>mn[o]||=Array.from(await gn("SHA-1",o)).map(e=>e.toString(36)).join(""),pn=async(o,e,t)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},Te(`${o}:${e}:${t}`)),{name:yt},!1,["encrypt","decrypt"]),Ot="$",Nt=",",hn=async(o,e)=>{const t=crypto.getRandomValues(new Uint8Array(16));return t.join(Nt)+Ot+vn(await crypto.subtle.encrypt({name:yt,iv:t},await o,Te(e)))},Sn=async(o,e)=>{const[t,n]=e.split(Ot);return qe(await crypto.subtle.decrypt({name:yt,iv:new Uint8Array(t.split(Nt))},await o,yn(n)))},wn=5e3,Et="icegatheringstatechange",bt="offer",En="answer",Rt=(o,{rtcConfig:e,rtcPolyfill:t,turnConfig:n})=>{const a=new(t||RTCPeerConnection)({iceServers:bn.concat(n||[]),...e}),s={};let l=!1,u=!1,c=null;const w=d=>{d.binaryType="arraybuffer",d.bufferedAmountLowThreshold=65535,d.onmessage=y=>s.data?.(y.data),d.onopen=()=>s.connect?.(),d.onclose=()=>s.close?.(),d.onerror=y=>s.error?.(y)},S=d=>Promise.race([new Promise(y=>{const i=()=>{d.iceGatheringState==="complete"&&(d.removeEventListener(Et,i),y())};d.addEventListener(Et,i),i()}),new Promise(y=>setTimeout(y,wn))]).then(()=>({type:d.localDescription.type,sdp:d.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return o?(c=a.createDataChannel("data"),w(c)):a.ondatachannel=({channel:d})=>{c=d,w(d)},a.onnegotiationneeded=async()=>{try{l=!0,await a.setLocalDescription();const d=await S(a);s.signal?.(d)}catch(d){s.error?.(d)}finally{l=!1}},a.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(a.connectionState)&&s.close?.()},a.ontrack=d=>{s.track?.(d.track,d.streams[0]),s.stream?.(d.streams[0])},a.onremovestream=d=>s.stream?.(d.stream),o&&(a.canTrickleIceCandidates||a.onnegotiationneeded()),{created:Date.now(),connection:a,get channel(){return c},get isDead(){return a.connectionState==="closed"},async signal(d){if(!(c?.readyState==="open"&&!d.sdp?.includes("a=rtpmap")))try{if(d.type===bt){if(l||a.signalingState!=="stable"&&!u){if(o)return;await we([a.setLocalDescription({type:"rollback"}),a.setRemoteDescription(d)])}else await a.setRemoteDescription(d);await a.setLocalDescription();const y=await S(a);return s.signal?.(y),y}else if(d.type===En){u=!0;try{await a.setRemoteDescription(d)}finally{u=!1}}}catch(y){s.error?.(y)}},sendData:d=>c.send(d),destroy:()=>{c?.close(),a.close(),l=!1,u=!1},setHandlers:d=>Object.assign(s,d),offerPromise:o?new Promise(d=>s.signal=y=>{y.type===bt&&d(y)}):Promise.resolve(),addStream:d=>d.getTracks().forEach(y=>a.addTrack(y,d)),removeStream:d=>a.getSenders().filter(y=>d.getTracks().includes(y.track)).forEach(y=>a.removeTrack(y)),addTrack:(d,y)=>a.addTrack(d,y),removeTrack:d=>{const y=a.getSenders().find(i=>i.track===d);y&&a.removeTrack(y)},replaceTrack:(d,y)=>{const i=a.getSenders().find(k=>k.track===d);if(i)return i.replaceTrack(y)}}},bn=[...$e(3,(o,e)=>`stun:stun${e||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(o=>({urls:o})),Rn=Object.getPrototypeOf(Uint8Array),Qe=12,Bt=0,Xe=Bt+Qe,Ze=Xe+1,xe=Ze+1,Fe=xe+1,he=16*2**10-Fe,ze=255,Mt="bufferedamountlow",Ee=o=>"@_"+o,Mn=(o,e,t)=>{const n={},a={},s={},l={},u={},c={},w={},S={onPeerJoin:fe,onPeerLeave:fe,onPeerStream:fe,onPeerTrack:fe},d=(v,b)=>(v?Array.isArray(v)?v:[v]:an(n)).flatMap(F=>{const _=n[F];return _?b(F,_):(console.warn(`${De}: no peer with id ${F} found`),[])}),y=v=>{n[v]&&(n[v].destroy(),delete n[v],delete l[v],delete u[v],S.onPeerLeave(v),e(v))},i=v=>{if(a[v])return s[v];if(!v)throw me("action type argument is required");const b=Te(v);if(b.byteLength>Qe)throw me(`action type string "${v}" (${b.byteLength}b) exceeds byte limit (${Qe}). Hint: choose a shorter name.`);const F=new Uint8Array(Qe);F.set(b);let _=0;return a[v]={onComplete:fe,onProgress:fe,setOnComplete:h=>a[v]={...a[v],onComplete:h},setOnProgress:h=>a[v]={...a[v],onProgress:h},send:async(h,p,R,N)=>{if(R&&typeof R!="object")throw me("action meta argument must be an object");const E=typeof h;if(E==="undefined")throw me("action data cannot be undefined");const g=E!=="string",O=h instanceof Blob,B=O||h instanceof ArrayBuffer||h instanceof Rn;if(R&&!B)throw me("action meta argument can only be used with binary data");const W=B?new Uint8Array(O?await h.arrayBuffer():h):Te(g?Oe(h):h),q=R?Te(Oe(R)):null,j=Math.ceil(W.byteLength/he)+(R?1:0)||1,Q=$e(j,(te,ne)=>{const le=ne===j-1,ce=R&&ne===0,de=new Uint8Array(Fe+(ce?q.byteLength:le?W.byteLength-he*(j-(R?2:1)):he));return de.set(F),de.set([_],Xe),de.set([le|ce<<1|B<<2|g<<3],Ze),de.set([Math.round((ne+1)/j*ze)],xe),de.set(R?ce?q:W.subarray((ne-1)*he,ne*he):W.subarray(ne*he,(ne+1)*he),Fe),de});return _=_+1&ze,we(d(p,async(te,ne)=>{const{channel:le}=ne;let ce=0;for(;ce<j;){const de=Q[ce];if(le.bufferedAmount>le.bufferedAmountLowThreshold&&await new Promise(Jt=>{const pt=()=>{le.removeEventListener(Mt,pt),Jt()};le.addEventListener(Mt,pt)}),!n[te])break;ne.sendData(de),ce++,N?.(de[xe]/ze,te,R)}}))}},s[v]||=[a[v].send,a[v].setOnComplete,a[v].setOnProgress]},k=(v,b)=>{const F=new Uint8Array(b),_=qe(F.subarray(Bt,Xe)).replaceAll("\0",""),[h]=F.subarray(Xe,Ze),[p]=F.subarray(Ze,xe),[R]=F.subarray(xe,Fe),N=F.subarray(Fe),E=!!(p&1),g=!!(p&2),O=!!(p&4),B=!!(p&8);if(!a[_]){console.warn(`${De}: received message with unregistered type (${_})`);return}l[v]||={},l[v][_]||={};const W=l[v][_][h]||={chunks:[]};if(g?W.meta=Ne(qe(N)):W.chunks.push(N),a[_].onProgress(R/ze,v,W.meta),!E)return;const q=new Uint8Array(W.chunks.reduce((j,Q)=>j+Q.byteLength,0));if(W.chunks.reduce((j,Q)=>(q.set(Q,j),j+Q.byteLength),0),delete l[v][_][h],O)a[_].onComplete(q,v,W.meta);else{const j=qe(q);a[_].onComplete(B?Ne(j):j,v)}},K=async()=>{await $(""),await new Promise(v=>setTimeout(v,99)),ft(n).forEach(([v,b])=>{b.destroy(),delete n[v]}),t()},[C,U]=i(Ee("ping")),[f,x]=i(Ee("pong")),[I,P]=i(Ee("signal")),[V,m]=i(Ee("stream")),[L,T]=i(Ee("track")),[$,H]=i(Ee("leave"));return o((v,b)=>{n[b]||(n[b]=v,v.setHandlers({data:F=>k(b,F),stream:F=>{S.onPeerStream(F,b,c[b]),delete c[b]},track:(F,_)=>{S.onPeerTrack(F,_,b,w[b]),delete w[b]},signal:F=>I(F,b),close:()=>y(b),error:F=>{console.error(F),y(b)}}),S.onPeerJoin(b))}),U((v,b)=>f("",b)),x((v,b)=>{u[b]?.(),delete u[b]}),P((v,b)=>n[b]?.signal(v)),m((v,b)=>c[b]=v),T((v,b)=>w[b]=v),H((v,b)=>y(b)),Dt&&addEventListener("beforeunload",K),{makeAction:i,leave:K,ping:async v=>{if(!v)throw me("ping() must be called with target peer ID");const b=Date.now();return C("",v),await new Promise(F=>u[v]=F),Date.now()-b},getPeers:()=>$t(ft(n).map(([v,b])=>[v,b.connection])),addStream:(v,b,F)=>d(b,async(_,h)=>{F&&await V(F,_),h.addStream(v)}),removeStream:(v,b)=>d(b,(F,_)=>_.removeStream(v)),addTrack:(v,b,F,_)=>d(F,async(h,p)=>{_&&await L(_,h),p.addTrack(v,b)}),removeTrack:(v,b)=>d(b,(F,_)=>_.removeTrack(v)),replaceTrack:(v,b,F,_)=>d(F,async(h,p)=>{_&&await L(_,h),p.replaceTrack(v,b)}),onPeerJoin:v=>S.onPeerJoin=v,onPeerLeave:v=>S.onPeerLeave=v,onPeerStream:v=>S.onPeerStream=v,onPeerTrack:v=>S.onPeerTrack=v}},Tn=20,An=5333,Tt=57333,Cn=({init:o,subscribe:e,announce:t})=>{const n={};let a=!1,s,l,u,c;return(w,S,d)=>{const{appId:y}=w;if(n[y]?.[S])return n[y][S];const i={},k={},K=Ke(De,y,S),C=_e(K),U=_e(Ke(K,Me)),f=pn(w.password||"",y,S),x=p=>async R=>({type:R.type,sdp:await p(f,R.sdp)}),I=x(Sn),P=x(hn),V=()=>Rt(!0,w),m=(p,R,N)=>{if(k[R]){k[R]!==p&&p.destroy();return}k[R]=p,h(p,R),i[R]?.forEach((E,g)=>{g!==N&&E.destroy()}),delete i[R]},L=(p,R)=>{k[R]===p&&delete k[R]},T=(p,R)=>{if(k[p])return;const N=i[p]?.[R];N&&(delete i[p][R],N.destroy())},$=p=>(l.push(...$e(p,V)),we(l.splice(0,p).map(R=>R.offerPromise.then(P).then(N=>({peer:R,offer:N}))))),H=(p,R)=>d?.({error:`incorrect password (${w.password}) when decrypting ${R}`,appId:y,peerId:p,roomId:S}),v=p=>async(R,N,E)=>{const[g,O]=await we([C,U]);if(R!==g&&R!==O)return;const{peerId:B,offer:W,answer:q,peer:j}=typeof N=="string"?Ne(N):N;if(!(B===Me||k[B])){if(B&&!W&&!q){if(i[B]?.[p])return;const[[{peer:Q,offer:te}],ne]=await we([$(1),_e(Ke(K,B))]);i[B]||=[],i[B][p]=Q,setTimeout(()=>T(B,p),b[p]*.9),Q.setHandlers({connect:()=>m(Q,B,p),close:()=>L(Q,B)}),E(ne,Oe({peerId:Me,offer:te}))}else if(W){if(i[B]?.[p]&&Me>B)return;const te=Rt(!1,w);te.setHandlers({connect:()=>m(te,B,p),close:()=>L(te,B)});let ne;try{ne=await I(W)}catch{H(B,"offer");return}if(te.isDead)return;const[le,ce]=await we([_e(Ke(K,B)),te.signal(ne)]);E(le,Oe({peerId:Me,answer:await P(ce)}))}else if(q){let Q;try{Q=await I(q)}catch{H(B,"answer");return}if(j)j.setHandlers({connect:()=>m(j,B,p),close:()=>L(j,B)}),j.signal(Q);else{const te=i[B]?.[p];te&&!te.isDead&&te.signal(Q)}}}};if(!w)throw me("requires a config map as the first argument");if(!y&&!w.firebaseApp)throw me("config map is missing appId field");if(!S)throw me("roomId argument required");if(!a){const p=o(w);l=$e(Tn,V),s=Array.isArray(p)?p:[p],a=!0,u=setInterval(()=>l=l.filter(R=>{const N=Date.now()-R.created<Tt;return N||R.destroy(),N}),Tt*1.03),c=w.manualRelayReconnection?fe:fn()}const b=s.map(()=>An),F=[],_=s.map(async(p,R)=>e(await p,await C,await U,v(R),$));we([C,U]).then(([p,R])=>{const N=async(E,g)=>{const O=await t(E,p,R);typeof O=="number"&&(b[g]=O),F[g]=setTimeout(()=>N(E,g),b[g])};_.forEach(async(E,g)=>{await E,N(await s[g],g)})});let h=fe;return n[y]||={},n[y][S]=Mn(p=>h=p,p=>delete k[p],()=>{delete n[y][S],F.forEach(clearTimeout),_.forEach(async p=>(await p)()),clearInterval(u),c(),a=!1})}},lt={},Kt={},Pe={},Ie={},ke={},At={},Ge={},Pn="announce",Ht=20,Ct=10,In=33333,kn=120333,_n=3,xn=async o=>{if(lt[o])return lt[o];const e=(await _e(o)).slice(0,Ht);return lt[o]=e,Kt[e]=o,e},Pt=async(o,e,t)=>o.send(Oe({action:Pn,info_hash:await xn(e),peer_id:Me,...t})),It=(o,e,t)=>console.warn(`${De}: torrent tracker ${t?"failure":"warning"} from ${o} - ${e}`),Fn=Cn({init:o=>ln(o,Un,_n).map(e=>{const t=un(e,a=>{const s=Ne(a),l=s["failure reason"],u=s["warning message"],{interval:c}=s,w=Kt[s.info_hash];if(l){It(n,l,!0);return}if(u&&It(n,u),c&&c*1e3>ke[n]&&Ie[n][w]){const S=Math.min(c*1e3,kn);clearInterval(Pe[n][w]),ke[n]=S,Pe[n][w]=setInterval(Ie[n][w],S)}At[s.offer_id]||(s.offer||s.answer)&&(At[s.offer_id]=!0,Ge[n][w]?.(s))}),{url:n}=t;return Ge[n]={},t.ready}),subscribe:(o,e,t,n,a)=>{const{url:s}=o,l=async()=>{const u=$t((await a(Ct)).map(c=>[Vt(Ht),c]));Ge[o.url][e]=c=>{if(c.offer)n(e,{offer:c.offer,peerId:c.peer_id},(w,S)=>Pt(o,e,{answer:Ne(S).answer,offer_id:c.offer_id,to_peer_id:c.peer_id}));else if(c.answer){const w=u[c.offer_id];w&&n(e,{answer:c.answer,peerId:c.peer_id,peer:w.peer})}},Pt(o,e,{numwant:Ct,offers:ft(u).map(([c,{offer:w}])=>({offer_id:c,offer:w}))})};return ke[s]=In,Ie[s]||={},Ie[s][e]=l,Pe[s]||={},Pe[s][e]=setInterval(l,ke[s]),l(),()=>{clearInterval(Pe[s][e]),delete Ge[s][e],delete Ie[s][e]}},announce:o=>ke[o.url]}),Un=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(o=>"wss://"+o);class re{static VALID_PROTOCOLS=["stun:","turn:","turns:"];static VALID_ICE_TRANSPORT_POLICIES=["all","relay"];static VALID_BUNDLE_POLICIES=["balanced","max-compat","max-bundle"];static VALID_RTCP_MUX_POLICIES=["negotiate","require"];static VALID_CREDENTIAL_TYPES=["password","oauth"];static MIN_ICE_CANDIDATE_POOL_SIZE=0;static MAX_ICE_CANDIDATE_POOL_SIZE=255;isValidIceServerUrl=e=>{if(typeof e!="string"||e.length===0||!re.VALID_PROTOCOLS.some(n=>e.startsWith(n)))return!1;try{return!(!/^(stun|turns?):[^:]+:\d+$/.test(e)&&!/^(stun|turns?):[^:]+$/.test(e))}catch{return!1}};isValidIceServer=e=>!(!e||typeof e!="object"||!e.urls||!(Array.isArray(e.urls)?e.urls:[e.urls]).every(n=>this.isValidIceServerUrl(n))||e.username!==void 0&&typeof e.username!="string"||e.credential!==void 0&&typeof e.credential!="string"||e.credentialType!==void 0&&!re.VALID_CREDENTIAL_TYPES.includes(e.credentialType));isValidRTCConfiguration=e=>{if(!e||typeof e!="object"||!Array.isArray(e.iceServers)||e.iceServers.length===0)return!1;for(const t of e.iceServers)if(!this.isValidIceServer(t))return!1;return!(e.iceTransportPolicy!==void 0&&!re.VALID_ICE_TRANSPORT_POLICIES.includes(e.iceTransportPolicy)||e.bundlePolicy!==void 0&&!re.VALID_BUNDLE_POLICIES.includes(e.bundlePolicy)||e.rtcpMuxPolicy!==void 0&&!re.VALID_RTCP_MUX_POLICIES.includes(e.rtcpMuxPolicy)||e.iceCandidatePoolSize!==void 0&&(typeof e.iceCandidatePoolSize!="number"||e.iceCandidatePoolSize<re.MIN_ICE_CANDIDATE_POOL_SIZE||e.iceCandidatePoolSize>re.MAX_ICE_CANDIDATE_POOL_SIZE))};sanitizeRTCConfiguration=e=>{if(!this.isValidRTCConfiguration(e))return null;const t={iceServers:(e.iceServers||[]).filter(this.isValidIceServer)};return e.iceTransportPolicy&&(t.iceTransportPolicy=e.iceTransportPolicy),e.bundlePolicy&&(t.bundlePolicy=e.bundlePolicy),e.rtcpMuxPolicy&&(t.rtcpMuxPolicy=e.rtcpMuxPolicy),typeof e.iceCandidatePoolSize=="number"&&(t.iceCandidatePoolSize=e.iceCandidatePoolSize),t};createDefaultRTCConfiguration=()=>({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}]});mergeRTCConfiguration=(e,t)=>{const n=t||this.createDefaultRTCConfiguration();if(!e)return n;const a=this.sanitizeRTCConfiguration(e);if(!a)return console.warn("用户提供的 RTC 配置无效，使用默认配置"),n;const s=[...n.iceServers||[],...a.iceServers||[]];return{...n,...a,iceServers:s}};validateRTCConfiguration=e=>{const t={valid:!0,errors:[]};return!e||typeof e!="object"?(t.valid=!1,t.errors.push({type:"INVALID_TYPE",message:"RTCConfiguration 必须是对象类型"}),t):e.iceServers?Array.isArray(e.iceServers)?e.iceServers.length===0?(t.valid=!1,t.errors.push({type:"EMPTY_ICE_SERVERS",message:"iceServers 不能为空",field:"iceServers"}),t):(e.iceServers.forEach((n,a)=>{this.isValidIceServer(n)||(t.valid=!1,t.errors.push({type:"INVALID_ICE_SERVER",message:`ICE 服务器 [${a}] 配置无效`,field:`iceServers[${a}]`}))}),e.iceTransportPolicy!==void 0&&(re.VALID_ICE_TRANSPORT_POLICIES.includes(e.iceTransportPolicy)||(t.valid=!1,t.errors.push({type:"INVALID_POLICY",message:`无效的 iceTransportPolicy: ${e.iceTransportPolicy}`,field:"iceTransportPolicy"}))),e.iceCandidatePoolSize!==void 0&&(typeof e.iceCandidatePoolSize!="number"||e.iceCandidatePoolSize<re.MIN_ICE_CANDIDATE_POOL_SIZE||e.iceCandidatePoolSize>re.MAX_ICE_CANDIDATE_POOL_SIZE)&&(t.valid=!1,t.errors.push({type:"INVALID_POOL_SIZE",message:"iceCandidatePoolSize 必须在 0-255 之间",field:"iceCandidatePoolSize"})),t):(t.valid=!1,t.errors.push({type:"INVALID_TYPE",message:"iceServers 必须是数组",field:"iceServers"}),t):(t.valid=!1,t.errors.push({type:"MISSING_ICE_SERVERS",message:"缺少 iceServers 字段",field:"iceServers"}),t)}}const Je=new re;class Ln{peerJoinHandlers=new Map;peerLeaveHandlers=new Map;peerStreamHandlers=new Map;onPeerJoin=(e,t)=>{this.peerJoinHandlers.has(e)||this.peerJoinHandlers.set(e,new Set),this.peerJoinHandlers.get(e).add(t)};onPeerLeave=(e,t)=>{this.peerLeaveHandlers.has(e)||this.peerLeaveHandlers.set(e,new Set),this.peerLeaveHandlers.get(e).add(t)};onPeerStream=(e,t)=>{this.peerStreamHandlers.has(e)||this.peerStreamHandlers.set(e,new Set),this.peerStreamHandlers.get(e).add(t)};offPeerJoin=e=>{this.peerJoinHandlers.delete(e)};offPeerLeave=e=>{this.peerLeaveHandlers.delete(e)};offPeerStream=e=>{this.peerStreamHandlers.delete(e)};triggerPeerJoin=e=>{this.peerJoinHandlers.forEach(t=>{t.forEach(n=>n(e))})};triggerPeerLeave=e=>{this.peerLeaveHandlers.forEach(t=>{t.forEach(n=>n(e))})};triggerPeerStream=(e,t,n)=>{this.peerStreamHandlers.forEach(a=>{a.forEach(s=>s(e,t,n))})};flush=()=>{this.peerJoinHandlers.clear(),this.peerLeaveHandlers.clear(),this.peerStreamHandlers.clear()};flushHookType=e=>{this.peerJoinHandlers.delete(e),this.peerLeaveHandlers.delete(e),this.peerStreamHandlers.delete(e)}}var Z=(o=>(o.GROUP="g",o.DIRECT_MESSAGE="dm",o))(Z||{}),vt=(o=>(o.DIRECT="DIRECT",o.RELAY="RELAY",o))(vt||{}),ee=(o=>(o.MESSAGE="MESSAGE",o.MEDIA_MESSAGE="MEDIA_MSG",o.PEER_METADATA="PEER_META",o.AUDIO_CHANGE="AUDIO_CHG",o.VIDEO_CHANGE="VIDEO_CHG",o.SCREEN_SHARE="SCREEN_SHR",o.FILE_OFFER="FILE_OFFER",o.TYPING_STATUS_CHANGE="TYPING_STS",o.MESSAGE_TRANSCRIPT="MSG_TRANS",o.VERIFICATION_REQUEST="VERIFY_REQ",o.VERIFICATION_RESPONSE="VERIFY_RES",o.PEER_NAME_CHANGE="NAME_CHG",o.ROOM_JOIN="ROOM_JOIN",o.ROOM_LEAVE="ROOM_LEAVE",o))(ee||{}),Ae=(o=>(o.NEW_PEER="NEW_PEER",o.STREAM="STREAM",o.FILE_SHARE="FILE_SHARE",o))(Ae||{}),Se=(o=>(o.AUDIO="AUDIO",o.VIDEO="VIDEO",o.SCREEN="SCREEN",o))(Se||{}),J=(o=>(o.WEBCAM="WEBCAM",o.MICROPHONE="MICROPHONE",o.SCREEN_SHARE="SCREEN_SHARE",o.SYSTEM_AUDIO_IN_SCREEN_SHARE="SYSTEM_AUDIO_IN_SCREEN_SHARE",o))(J||{});const Vn={SCREEN_SHARE:["SCREEN_SHARE","SYSTEM_AUDIO_IN_SCREEN_SHARE"]},kt={AUDIO:["MICROPHONE"],VIDEO:["MICROPHONE","WEBCAM"],SCREEN:["MICROPHONE","SCREEN_SHARE"]};class Dn{constructor(e){this.room=e}actions=new Map;makeAction=(e,t)=>{const n=`${t}.${e}`;if(this.actions.has(n))return this.actions.get(n);const[a,s,l]=this.room.makeAction(n),c=[a,s,l,()=>{this.actions.delete(n)}];return this.actions.set(n,c),c};createMessageAction=e=>{const[t,n]=this.makeAction(ee.MESSAGE,e);return{sendMessage:t,onMessage:n}};createMetadataAction=e=>{const[t,n]=this.makeAction(ee.PEER_METADATA,e);return{sendMetadata:t,onMetadata:n}};createTypingAction=e=>{const[t,n]=this.makeAction(ee.TYPING_STATUS_CHANGE,e);return{sendTyping:t,onTyping:n}};createMediaAction=e=>{const[t,n]=this.makeAction(ee.MEDIA_MESSAGE,e);return{sendMedia:t,onMedia:n}};createAudioChangeAction=e=>{const[t,n]=this.makeAction(ee.AUDIO_CHANGE,e);return{sendAudioChange:t,onAudioChange:n}};createVideoChangeAction=e=>{const[t,n]=this.makeAction(ee.VIDEO_CHANGE,e);return{sendVideoChange:t,onVideoChange:n}};createScreenShareAction=e=>{const[t,n]=this.makeAction(ee.SCREEN_SHARE,e);return{sendScreenShare:t,onScreenShare:n}};createFileOfferAction=e=>{const[t,n]=this.makeAction(ee.FILE_OFFER,e);return{sendFileOffer:t,onFileOffer:n}};createMessageTranscriptAction=e=>{const[t,n]=this.makeAction(ee.MESSAGE_TRANSCRIPT,e);return{sendTranscript:t,onTranscript:n}};createVerificationRequestAction=e=>{const[t,n]=this.makeAction(ee.VERIFICATION_REQUEST,e);return{sendVerifyRequest:t,onVerifyRequest:n}};createVerificationResponseAction=e=>{const[t,n]=this.makeAction(ee.VERIFICATION_RESPONSE,e);return{sendVerifyResponse:t,onVerifyResponse:n}};createPeerNameChangeAction=e=>{const[t,n]=this.makeAction(ee.PEER_NAME_CHANGE,e);return{sendNameChange:t,onNameChange:n}};createRoomJoinAction=e=>{const[t,n]=this.makeAction(ee.ROOM_JOIN,e);return{sendRoomJoin:t,onRoomJoin:n}};createRoomLeaveAction=e=>{const[t,n]=this.makeAction(ee.ROOM_LEAVE,e);return{sendRoomLeave:t,onRoomLeave:n}};cleanup=()=>{this.actions.forEach(([,,,e])=>e()),this.actions.clear()}}const $n=1e3,On=o=>new Promise(e=>setTimeout(e,o));class Nn{constructor(e){this.room=e}streamQueue=[];isProcessingPendingStreams=!1;processPendingStreams=async()=>{if(!this.isProcessingPendingStreams){for(this.isProcessingPendingStreams=!0;this.streamQueue.length>0;){const e=this.streamQueue.shift();e&&await e()}this.isProcessingPendingStreams=!1}};addStream=(e,t,n)=>{this.streamQueue.push(()=>Promise.all(this.room.addStream(e,t,n)),()=>On($n)),this.processPendingStreams()};removeStream=(e,t)=>this.room.removeStream(e,t);cleanup=()=>{this.streamQueue=[],this.isProcessingPendingStreams=!1}}class Bn{constructor(e){this.room=e}getPeerConnectionTypes=async()=>{const e=this.room.getPeers(),t={};return await Promise.all(Object.entries(e).map(async([n,a])=>{const s=await a.getStats();let l;for(const{type:c,state:w,localCandidateId:S}of s.values())if(c==="candidate-pair"&&w==="succeeded"&&S){l=S;break}const u=!!l&&s.get(l)?.candidateType==="relay";t[n]=u?vt.RELAY:vt.DIRECT})),t};getPeers=()=>{const e=this.room.getPeers();return Object.keys(e)}}const be="RSA-OAEP",_t="SHA-256",xt=o=>{const e=String.fromCharCode(...new Uint8Array(o));return btoa(e)},Ft=o=>{const e=atob(o),t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t.buffer};class Kn{generateKeyPair=async()=>await window.crypto.subtle.generateKey({name:be,hash:_t,modulusLength:2048,publicExponent:new Uint8Array([1,0,1])},!0,["encrypt","decrypt"]);stringifyCryptoKey=async e=>{const t=await window.crypto.subtle.exportKey(e.type==="public"?"spki":"pkcs8",e);return xt(t)};parseCryptoKey=async(e,t)=>await window.crypto.subtle.importKey(t==="public"?"spki":"pkcs8",Ft(e),{name:be,hash:_t},!0,t==="public"?["encrypt"]:["decrypt"]);encryptString=async(e,t)=>{const n=new TextEncoder().encode(t);return await crypto.subtle.encrypt(be,e,n)};decryptString=async(e,t)=>{const n=await crypto.subtle.decrypt(be,e,t);return new TextDecoder().decode(n)};generateAESKey=async()=>await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);exportAESKey=async e=>{const t=await window.crypto.subtle.exportKey("raw",e);return xt(t)};importAESKey=async e=>{const t=Ft(e);return await window.crypto.subtle.importKey("raw",t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])};encryptFile=async(e,t)=>{const n=window.crypto.getRandomValues(new Uint8Array(12)),a=await e.arrayBuffer();return{encryptedData:await window.crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,a),iv:n}};decryptFile=async(e,t,n)=>await window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e);encryptAESKey=async(e,t)=>{const n=await window.crypto.subtle.exportKey("raw",e);return await window.crypto.subtle.encrypt(be,t,n)};decryptAESKey=async(e,t)=>{const n=await window.crypto.subtle.decrypt(be,t,e);return await window.crypto.subtle.importKey("raw",n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])};encryptText=async(e,t)=>{const n=window.crypto.getRandomValues(new Uint8Array(12)),a=new TextEncoder().encode(e);return{encryptedData:await window.crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,a),iv:n}};decryptText=async(e,t,n)=>{const a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e);return new TextDecoder().decode(a)}}const Y=new Kn;var et=(o=>(o.VERIFYING="VERIFYING",o.VERIFIED="VERIFIED",o.UNVERIFIED="UNVERIFIED",o))(et||{});const Hn={timeout:3e4,tokenLength:32,namespace:Z.GROUP};class zn{peerRoom;config;verificationMap=new Map;publicKeyMap=new Map;localPrivateKey=null;initialized=!1;constructor(e,t={}){this.peerRoom=e,this.config={...Hn,...t}}initialize=()=>{this.initialized||(this.setupVerificationChannels(),this.initialized=!0)};setupVerificationChannels=()=>{const[e,t]=this.peerRoom.makeAction(ee.VERIFICATION_REQUEST,this.config.namespace),[n,a]=this.peerRoom.makeAction(ee.VERIFICATION_RESPONSE,this.config.namespace);t(async(s,l)=>{await this.handleEncryptedTokenReceived(s,l)}),a(async(s,l)=>{await this.handleRawTokenReceived(s,l)}),this.sendEncryptedToken=e,this.sendRawToken=n};generateToken=()=>{const e=new Uint8Array(this.config.tokenLength);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")};generateRequestId=()=>`verify-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;setLocalPrivateKey=e=>{this.localPrivateKey=e};registerPublicKey=(e,t)=>{this.initialize(),this.publicKeyMap.set(e,t)};initiateVerification=async(e,t,n)=>{this.initialize();const a=this.generateToken(),s=this.generateRequestId(),l=await Y.encryptString(t,a),u=this.arrayBufferToBase64(l),c={peerId:e,state:"VERIFYING",localToken:a,encryptedLocalToken:u,requestId:s,timestamp:Date.now()};c.timeoutTimer=setTimeout(()=>{this.handleVerificationTimeout(e)},this.config.timeout),this.verificationMap.set(e,c),this.publicKeyMap.set(e,t);const w=this.sendEncryptedToken;w({requestId:s,encryptedToken:u,timestamp:Date.now()},e),console.log(`[验证] 向 ${e} 发送验证请求 (ID: ${s})`)};handleEncryptedTokenReceived=async(e,t)=>{console.log(`[验证] 收到来自 ${t} 的验证请求 (ID: ${e.requestId})`);try{const n=await this.getPrivateKey();if(!n)throw new Error("本地私钥不可用");const a=this.base64ToArrayBuffer(e.encryptedToken),s=await Y.decryptString(n,a);console.log(`[验证] 成功解密来自 ${t} 的令牌`);const l=this.sendRawToken;l({requestId:e.requestId,decryptedToken:s,timestamp:Date.now()},t),console.log(`[验证] 向 ${t} 发送验证响应 (ID: ${e.requestId})`)}catch(n){console.error(`[验证] 处理来自 ${t} 的验证请求失败:`,n),this.setVerificationState(t,"UNVERIFIED")}};handleRawTokenReceived=async(e,t)=>{console.log(`[验证] 收到来自 ${t} 的验证响应 (ID: ${e.requestId})`);const n=this.verificationMap.get(t);if(!n){console.warn(`[验证] 未找到 ${t} 的验证元数据`);return}if(n.requestId!==e.requestId){console.warn(`[验证] 请求 ID 不匹配: ${n.requestId} != ${e.requestId}`),this.setVerificationState(t,"UNVERIFIED");return}n.timeoutTimer&&clearTimeout(n.timeoutTimer),e.decryptedToken===n.localToken?(console.log(`[验证] ✅ ${t} 验证成功`),n.remoteToken=e.decryptedToken,this.setVerificationState(t,"VERIFIED")):(console.warn(`[验证] ❌ ${t} 验证失败：令牌不匹配`),this.setVerificationState(t,"UNVERIFIED"))};handleVerificationTimeout=e=>{console.warn(`[验证] ⏱️ ${e} 验证超时`),this.setVerificationState(e,"UNVERIFIED")};setVerificationState=(e,t)=>{const n=this.verificationMap.get(e);n&&(n.state=t,this.verificationMap.set(e,n))};getVerificationState=e=>this.verificationMap.get(e)?.state??"UNVERIFIED";isVerified=e=>this.getVerificationState(e)==="VERIFIED";getVerifiedPeers=()=>{const e=[];return this.verificationMap.forEach((t,n)=>{t.state==="VERIFIED"&&e.push(n)}),e};getVerificationMetadata=e=>this.verificationMap.get(e);removePeer=e=>{const t=this.verificationMap.get(e);t?.timeoutTimer&&clearTimeout(t.timeoutTimer),this.verificationMap.delete(e),this.publicKeyMap.delete(e),console.log(`[验证] 移除 ${e} 的验证数据`)};cleanup=()=>{this.verificationMap.forEach(e=>{e.timeoutTimer&&clearTimeout(e.timeoutTimer)}),this.verificationMap.clear(),this.publicKeyMap.clear(),console.log("[验证] 清理所有验证数据")};getPrivateKey=async()=>this.localPrivateKey;arrayBufferToBase64=e=>{const t=new Uint8Array(e);let n="";for(let a=0;a<t.byteLength;a++)n+=String.fromCharCode(t[a]);return btoa(n)};base64ToArrayBuffer=e=>{const t=atob(e),n=new Uint8Array(t.length);for(let a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return n.buffer}}class Gn{room;actionManager;connectionManager;eventManager;streamManager;verificationManager;constructor(e,t={}){const{appId:n="chat-p2p-mvp",password:a,rtcConfig:s}=t;let l;s?Je.isValidRTCConfiguration(s)?l=s:(console.warn("提供的 RTC 配置无效，尝试清理..."),l=Je.sanitizeRTCConfiguration(s)||Je.createDefaultRTCConfiguration()):l=Je.createDefaultRTCConfiguration(),this.room=Fn({appId:n,password:a||e,rtcConfig:l},e),this.eventManager=new Ln,this.actionManager=new Dn(this.room),this.streamManager=new Nn(this.room),this.connectionManager=new Bn(this.room),this.verificationManager=new zn(this,t.verificationConfig),setTimeout(()=>{this.verificationManager.initialize()},0),this.room.onPeerJoin(u=>{this.eventManager.triggerPeerJoin(u)}),this.room.onPeerLeave(u=>{this.eventManager.triggerPeerLeave(u)}),this.room.onPeerStream((u,c,w)=>{this.eventManager.triggerPeerStream(u,c,w)})}onPeerJoin=(e,t)=>{this.eventManager.onPeerJoin(e,t)};onPeerLeave=(e,t)=>{this.eventManager.onPeerLeave(e,t)};onPeerStream=(e,t)=>{this.eventManager.onPeerStream(e,t)};offPeerJoin=e=>{this.eventManager.offPeerJoin(e)};offPeerLeave=e=>{this.eventManager.offPeerLeave(e)};offPeerStream=e=>{this.eventManager.offPeerStream(e)};makeAction=(e,t)=>this.actionManager.makeAction(e,t);createMessageAction=(e=Z.GROUP)=>this.actionManager.createMessageAction(e);createMetadataAction=(e=Z.GROUP)=>this.actionManager.createMetadataAction(e);createTypingAction=(e=Z.GROUP)=>this.actionManager.createTypingAction(e);createMediaAction=(e=Z.GROUP)=>this.actionManager.createMediaAction(e);createAudioChangeAction=(e=Z.GROUP)=>this.actionManager.createAudioChangeAction(e);createVideoChangeAction=(e=Z.GROUP)=>this.actionManager.createVideoChangeAction(e);createScreenShareAction=(e=Z.GROUP)=>this.actionManager.createScreenShareAction(e);createFileOfferAction=(e=Z.GROUP)=>this.actionManager.createFileOfferAction(e);createMessageTranscriptAction=(e=Z.GROUP)=>this.actionManager.createMessageTranscriptAction(e);createVerificationRequestAction=(e=Z.GROUP)=>this.actionManager.createVerificationRequestAction(e);createVerificationResponseAction=(e=Z.GROUP)=>this.actionManager.createVerificationResponseAction(e);createPeerNameChangeAction=(e=Z.GROUP)=>this.actionManager.createPeerNameChangeAction(e);createRoomJoinAction=(e=Z.GROUP)=>this.actionManager.createRoomJoinAction(e);createRoomLeaveAction=(e=Z.GROUP)=>this.actionManager.createRoomLeaveAction(e);addStream=(e,t,n)=>{this.streamManager.addStream(e,t,n)};removeStream=(e,t)=>this.streamManager.removeStream(e,t);getPeerConnectionTypes=async()=>this.connectionManager.getPeerConnectionTypes();getPeers=()=>this.connectionManager.getPeers();flush=()=>{this.eventManager.flush()};flushHookType=e=>{this.eventManager.flushHookType(e)};setLocalPrivateKey=e=>{this.verificationManager.setLocalPrivateKey(e)};initiateVerification=async(e,t,n)=>this.verificationManager.initiateVerification(e,t,n);registerPublicKey=(e,t)=>{this.verificationManager.registerPublicKey(e,t)};getVerificationState=e=>this.verificationManager.getVerificationState(e);isVerified=e=>this.verificationManager.isVerified(e);getVerificationMetadata=e=>this.verificationManager.getVerificationMetadata(e);getVerifiedPeers=()=>this.verificationManager.getVerifiedPeers();removePeerVerification=e=>{this.verificationManager.removePeer(e)};leave=()=>{this.actionManager.cleanup(),this.streamManager.cleanup(),this.verificationManager.cleanup(),this.eventManager.flush(),this.room.leave()}}const rt="User_",zt=o=>{if(!o)return"?";const e=o.trim();if(e.startsWith(rt))return e.slice(rt.length).slice(0,4).toUpperCase();if(/[\u4e00-\u9fa5]/.test(e))return e.slice(0,2);const t=e.split(/\s+/);return t.length>=2&&t[0]&&t[1]?((t[0][0]||"")+(t[1][0]||"")).toUpperCase():e.slice(0,2).toUpperCase()},Jn=o=>o?rt+o.slice(0,4):rt+"Unknown",Wn={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:relay1.expressturn.com:3478"],username:"efQUQ79N77B5BNVVKF",credential:"N4EAUgpjMzPLrxSS"}]},jn=o=>{const e=D(new Map),t=D(new Map),n=D({isAudioEnabled:!1,isVideoEnabled:!1,isScreenSharing:!1,isSystemAudioEnabled:!1}),a=z(()=>e.value.get(J.MICROPHONE)||null),s=z(()=>e.value.get(J.WEBCAM)||null),l=z(()=>e.value.get(J.SCREEN_SHARE)||null),u=z(()=>e.value.get(J.SYSTEM_AUDIO_IN_SCREEN_SHARE)||null),c=z(()=>{const P=[];return t.value.forEach((V,m)=>{V.forEach((L,T)=>{P.push({peerId:m,type:T,stream:L,hasVideo:L.getVideoTracks().length>0,hasAudio:L.getAudioTracks().length>0})})}),P}),w=()=>{o.value&&(o.value.onPeerJoin(Ae.STREAM,P=>{for(const[V,m]of e.value.entries())console.log("[useMedia] 新 peer 加入，发送流给:",P,V,m),o.value?.addStream(m,[P],{type:V})}),o.value.onPeerLeave(Ae.STREAM,P=>{for(const[V,m]of e.value.entries())o.value?.removeStream(m,[P]),console.log("[useMedia] 对等方离开，移除流:",P,V,m)}),o.value.onPeerStream(Ae.STREAM,(P,V,m)=>{const L=t.value.get(V)||new Map;L.set(m?.type,P),t.value.set(V,L),console.log("[useMedia] 流已保存到 peerStreamTypeMap",V,L)}),console.log("[useMedia] 媒体事件监听器已初始化"))},S=async P=>{const V=new Map;let m=null;if(P===J.MICROPHONE)console.log("[useMedia] 请求麦克风权限..."),m=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1}),V.set(P,m);else if(P===J.WEBCAM)console.log("[useMedia] 请求摄像头权限..."),m=await navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"}}),V.set(P,m);else if(P===J.SCREEN_SHARE){console.log("[useMedia] 请求屏幕共享权限...");let L=await navigator.mediaDevices.getDisplayMedia({video:{width:{ideal:1920},height:{ideal:1080}},audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}});Vn[J.SCREEN_SHARE]?.forEach(T=>{if(T===J.SCREEN_SHARE&&(m=new MediaStream,L.getVideoTracks().forEach($=>{m.addTrack($)}),console.log("[useMedia] 屏幕视频已包含"),V.set(J.SCREEN_SHARE,m)),T===J.SYSTEM_AUDIO_IN_SCREEN_SHARE){const $=L.getAudioTracks();$.length>0&&(m=new MediaStream,$.forEach(H=>{m.addTrack(H)}),console.log("[useMedia] 系统音频已包含"),V.set(J.SYSTEM_AUDIO_IN_SCREEN_SHARE,m))}})}return V},d=async(P,V)=>{if(!o.value)throw new Error("PeerRoom 未初始化");try{for(const m of kt[P]){const L=await S(m);if(L.size>0)for(const[T,$]of L.entries())e.value.has(T)||(e.value.set(T,$),o.value.addStream($,V,{type:T}),console.log("[useMedia] 流已添加:",T));else console.error("[useMedia] 获取流失败:",m)}i()}catch(m){throw console.error(`[useMedia] 启动${P}失败:`,m),m}},y=async(P,V)=>{if(!o.value)throw new Error("PeerRoom 未初始化");for(const m of kt[P])if(e.value.has(m)){if(m===J.SCREEN_SHARE){const T=e.value.get(J.SYSTEM_AUDIO_IN_SCREEN_SHARE);T&&(o.value.removeStream(T,V),T.getTracks().forEach($=>$.stop()),e.value.delete(J.SYSTEM_AUDIO_IN_SCREEN_SHARE),console.log("[useMedia] 系统音频流已停止"))}const L=e.value.get(m);L&&(o.value.removeStream(L,V),L.getTracks().forEach(T=>T.stop()),e.value.delete(m),console.log(`[useMedia] ${P}已停止`))}i()},i=()=>{n.value.isAudioEnabled=e.value.has(J.MICROPHONE),n.value.isVideoEnabled=e.value.has(J.WEBCAM),n.value.isScreenSharing=e.value.has(J.SCREEN_SHARE),n.value.isSystemAudioEnabled=e.value.has(J.SYSTEM_AUDIO_IN_SCREEN_SHARE)},k=async()=>{await d(Se.AUDIO)},K=()=>{y(Se.AUDIO)},C=async()=>{d(Se.VIDEO)},U=()=>{y(Se.VIDEO)},f=async()=>{d(Se.SCREEN)},x=()=>{y(Se.SCREEN)};return{initializeMediaListeners:w,mediaState:n,localAudioStream:a,localVideoStream:s,localScreenStream:l,localSystemAudioStream:u,remotePeerStreams:c,startAudioCall:k,stopAudioCall:K,startVideoCall:C,stopVideoCall:U,startScreenShare:f,stopScreenShare:x,cleanup:()=>{console.log("[useMedia] 清理所有媒体资源"),K(),U(),x(),t.value.clear()}}},We=["wss://tracker.openwebtorrent.com","wss://tracker.webtorrent.dev","wss://tracker.btorrent.xyz","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.io","https://tracker.openwebtorrent.com/announce"],Yn="/undefined//vendor/StreamSaver.min.js",Re={image:["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/svg+xml"],audio:["audio/mpeg","audio/mp3","audio/wav","audio/ogg","audio/webm"],video:["video/mp4","video/webm","video/ogg","video/quicktime"]};class qn{client=null;fileMetadataMap=new Map;downloadProgressMap=new Map;torrentMap=new Map;streamSaverLoaded=!1;rtcConfig;constructor(e){this.rtcConfig=e||{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},this.initializeWebTorrent(),this.loadStreamSaver()}initializeWebTorrent=()=>{try{this.client=new Xt({tracker:{rtcConfig:this.rtcConfig,announce:We}}),this.client.on("error",e=>{console.error("[FileTransferService] WebTorrent 错误:",e)}),console.log("[FileTransferService] WebTorrent 客户端已初始化"),console.log("[FileTransferService] 使用 Tracker URLs:",We)}catch(e){console.error("[FileTransferService] WebTorrent 初始化失败:",e)}};loadStreamSaver=async()=>{if(!(this.streamSaverLoaded||typeof window>"u"))return new Promise((e,t)=>{const n=document.createElement("script");n.src=Yn,n.async=!0,n.onload=()=>{this.streamSaverLoaded=!0,console.log("[FileTransferService] StreamSaver.js 加载成功"),typeof window.streamSaver<"u"&&(window.streamSaver.mitm="/vendor/sw.js",console.log("[FileTransferService] StreamSaver mitm 配置为本地文件")),e()},n.onerror=()=>{console.error("[FileTransferService] StreamSaver.js 加载失败"),t(new Error("Failed to load StreamSaver.js"))},document.head.appendChild(n)})};isInlineMediaType=e=>[...Re.image,...Re.audio,...Re.video].includes(e.toLowerCase());getMediaCategory=e=>{const t=e.toLowerCase();return Re.image.includes(t)?"image":Re.audio.includes(t)?"audio":Re.video.includes(t)?"video":"file"};createBlobUrl=e=>URL.createObjectURL(e);revokeBlobUrl=e=>{URL.revokeObjectURL(e)};prepareFileForTransfer=async e=>{const t=crypto.randomUUID(),n=this.isInlineMediaType(e.type);if(!this.client)throw new Error("WebTorrent client not initialized");try{console.log("[FileTransferService] 开始加密文件:",e.name);const a=await Y.generateAESKey(),{encryptedData:s,iv:l}=await Y.encryptFile(e,a);console.log("[FileTransferService] 文件加密完成，大小:",s.byteLength);const u=new Blob([s],{type:"application/octet-stream"}),c=new File([u],e.name+".encrypted",{type:"application/octet-stream"});return new Promise((w,S)=>{this.client.seed(c,{announce:We},d=>{console.log("[FileTransferService] 加密文件种子创建成功:",d.magnetURI);const y={id:t,name:e.name,size:e.size,type:e.type,magnetURI:d.magnetURI,isInline:n,timestamp:Date.now(),aesKey:a,iv:l};this.fileMetadataMap.set(t,y),this.torrentMap.set(t,d),this.torrentMap.set(d.magnetURI,d),d.on("upload",()=>{console.log("[FileTransferService] 正在上传加密文件:",d.name,"进度:",d.progress)}),d.on("error",i=>{console.error("[FileTransferService] 种子错误:",i),S(i)}),w(y)})})}catch(a){throw console.error("[FileTransferService] 文件加密失败:",a),a}};downloadFileByMagnetURI=async(e,t,n,a)=>{try{const s=await this.downloadEncryptedFile(e,a);console.log("[FileTransferService] 加密文件下载完成，开始解密");const l=await s.arrayBuffer(),u=await Y.decryptFile(l,t,n);return console.log("[FileTransferService] 文件解密完成，大小:",u.byteLength),new Blob([u])}catch(s){throw console.error("[FileTransferService] 文件下载或解密失败:",s),s}};downloadEncryptedFile=async(e,t)=>{if(!this.client)throw new Error("WebTorrent client not initialized");return new Promise((n,a)=>{console.log("[FileTransferService] 开始下载文件，MagnetURI:",e);const s=this.torrentMap.get(e);if(s){if(console.log("[FileTransferService] 发现已存在的种子:",{name:s.name,ready:s.ready,done:s.done,progress:s.progress,numPeers:s.numPeers}),s.done){console.log("[FileTransferService] 种子已完成，直接获取 Blob"),this.getBlobFromTorrent(s,n,a);return}if(s.ready){console.log("[FileTransferService] 种子已就绪，监听下载"),this.handleTorrentDownload(s,t,n,a);return}console.log("[FileTransferService] 种子未就绪，等待就绪事件");const l=setTimeout(()=>{console.error("[FileTransferService] 等待种子就绪超时"),a(new Error("Torrent ready timeout"))},3e4);s.on("ready",()=>{clearTimeout(l),console.log("[FileTransferService] 种子现在就绪了"),this.handleTorrentDownload(s,t,n,a)}),s.once("error",u=>{clearTimeout(l),console.error("[FileTransferService] 种子错误:",u),a(u)});return}console.log("[FileTransferService] 添加新种子"),this.client.add(e,{announce:We},l=>{if(console.log("[FileTransferService] 种子添加成功:",l.name),console.log("[FileTransferService] 种子信息:",{infoHash:l.infoHash,ready:l.ready,done:l.done,numPeers:l.numPeers}),this.torrentMap.set(e,l),!l||typeof l.on!="function"){console.error("[FileTransferService] 无效的 torrent 对象"),a(new Error("Invalid torrent object"));return}this.handleTorrentDownload(l,t,n,a)})})};handleTorrentDownload=(e,t,n,a)=>{if(!e||typeof e.on!="function"){console.error("[FileTransferService] 无效的 torrent 对象:",e),a(new Error("Invalid torrent object"));return}if(console.log("[FileTransferService] 处理种子下载:",{name:e.name,infoHash:e.infoHash,ready:e.ready,done:e.done,progress:e.progress,numPeers:e.numPeers,downloaded:e.downloaded,length:e.length}),e.done){console.log("[FileTransferService] 种子已下载完成"),this.getBlobFromTorrent(e,n,a);return}const s=setTimeout(()=>{console.error("[FileTransferService] 下载超时，numPeers:",e.numPeers),e.removeListener("download",l),e.removeListener("done",u),e.removeListener("error",c),a(new Error("Download timeout - no peers available"))},6e4),l=()=>{const S=e.progress*100;console.log("[FileTransferService] 下载进度:",S.toFixed(2)+"%","Peers:",e.numPeers,"Speed:",(e.downloadSpeed/1024).toFixed(2),"KB/s"),t&&t(S)};e.on("download",l);const u=()=>{clearTimeout(s),console.log("[FileTransferService] 下载完成:",e.name),e.removeListener("download",l),e.removeListener("done",u),e.removeListener("error",c),e.removeListener("noPeers",w),this.getBlobFromTorrent(e,n,a)};e.on("done",u);const c=S=>{clearTimeout(s),console.error("[FileTransferService] 下载错误:",S),e.removeListener("download",l),e.removeListener("done",u),e.removeListener("error",c),e.removeListener("noPeers",w),a(S)};e.on("error",c);const w=()=>{console.warn("[FileTransferService] 没有可用的 peers")};e.on("noPeers",w),e.on("wire",S=>{console.log("[FileTransferService] 新的 peer 连接:",S.peerId)})};getBlobFromTorrent=(e,t,n)=>{if(e.files.length===0){n(new Error("No files in torrent"));return}const a=e.files[0];if(console.log("[FileTransferService] 获取文件 Blob:",a.name,"大小:",a.length),console.log("[FileTransferService] 可用方法:",Object.keys(a).filter(s=>typeof a[s]=="function")),typeof a.getBlobURL=="function"){console.log("[FileTransferService] 使用 getBlobURL 方法"),a.getBlobURL((s,l)=>{if(console.log("[FileTransferService] getBlobURL 回调, err:",s,"url:",l),s){console.error("[FileTransferService] getBlobURL 失败:",s),this.tryStreamMethod(a,t,n);return}l?fetch(l).then(u=>u.blob()).then(u=>{console.log("[FileTransferService] 成功通过 getBlobURL 获取 Blob, 大小:",u.size,"类型:",u.type),t(u)}).catch(u=>{console.error("[FileTransferService] fetch blob 失败:",u),this.tryStreamMethod(a,t,n)}):this.tryStreamMethod(a,t,n)});return}if(typeof a.getBuffer=="function"){console.log("[FileTransferService] 使用 getBuffer 方法"),a.getBuffer((s,l)=>{if(console.log("[FileTransferService] getBuffer 回调, err:",s,"buffer:",l?l.length:null),s){console.error("[FileTransferService] getBuffer 失败:",s),this.tryStreamMethod(a,t,n);return}if(l){const u=new Blob([l],{type:a.type||"application/octet-stream"});console.log("[FileTransferService] 成功通过 getBuffer 创建 Blob, 大小:",u.size,"类型:",u.type),t(u)}else this.tryStreamMethod(a,t,n)});return}this.tryStreamMethod(a,t,n)};tryStreamMethod=async(e,t,n)=>{try{if(console.log("[FileTransferService] 尝试流方法"),console.log("[FileTransferService] file 对象的所有属性:",Object.keys(e)),console.log("[FileTransferService] file 对象的所有方法:",Object.keys(e).filter(a=>typeof e[a]=="function")),typeof e.createReadStream=="function"){console.log("[FileTransferService] 使用 createReadStream");const a=e.createReadStream(),s=[];a.on("data",l=>{console.log("[FileTransferService] 收到数据块:",l.length),s.push(l)}),a.on("end",()=>{console.log("[FileTransferService] 流结束，总块数:",s.length);const l=new Blob(s,{type:e.type||"application/octet-stream"});console.log("[FileTransferService] 成功通过 createReadStream 创建 Blob, 大小:",l.size),t(l)}),a.on("error",l=>{console.error("[FileTransferService] createReadStream 失败:",l),n(l)});return}if(typeof e.streamTo=="function"){console.log("[FileTransferService] 使用 streamTo");const a=[],s=new WritableStream({write(l){a.push(l)},close(){const l=new Blob(a,{type:e.type||"application/octet-stream"});console.log("[FileTransferService] 成功通过 streamTo 创建 Blob"),t(l)},abort(l){console.error("[FileTransferService] streamTo 失败:",l),n(l)}});e.streamTo(s);return}console.error("[FileTransferService] 所有获取 Blob 的方法都不可用"),console.error("[FileTransferService] 请检查 WebTorrent 版本和文档"),n(new Error("No method available to get Blob from file. Available methods: "+Object.keys(e).filter(a=>typeof e[a]=="function").join(", ")))}catch(a){console.error("[FileTransferService] tryStreamMethod 错误:",a),n(a)}};getFileMetadata=e=>this.fileMetadataMap.get(e);updateDownloadProgress=(e,t,n)=>{const a={fileId:e,progress:t,status:n};this.downloadProgressMap.set(e,a)};getDownloadProgress=e=>this.downloadProgressMap.get(e);formatFileSize=e=>{if(e===0)return"0 B";const t=1024,n=["B","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(t));return`${parseFloat((e/Math.pow(t,a)).toFixed(2))} ${n[a]}`};downloadFile=(e,t)=>{const n=this.createBlobUrl(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>{this.revokeBlobUrl(n)},100)};downloadLargeFile=async(e,t,n)=>{if(this.streamSaverLoaded||await this.loadStreamSaver(),typeof window.streamSaver>"u")throw new Error("StreamSaver is not available");const s=window.streamSaver.createWriteStream(t,{size:n}).getWriter(),l=e.getReader();try{for(;;){const{done:u,value:c}=await l.read();if(u)break;await s.write(c)}}finally{await s.close()}};cleanup=()=>{this.client&&(this.client.destroy(e=>{e?console.error("[FileTransferService] WebTorrent 清理失败:",e):console.log("[FileTransferService] WebTorrent 已清理")}),this.client=null),this.fileMetadataMap.clear(),this.downloadProgressMap.clear(),this.torrentMap.clear()};getClient=()=>this.client}const oe=new qn,Ut=o=>{const e=String.fromCharCode(...new Uint8Array(o));return btoa(e)},Lt=o=>{const e=atob(o),t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t.buffer},Qn=(o,e,t)=>{const n=D([]),a=D(new Map),s=new Map,{sendFileOffer:l,onFileOffer:u}=o.createFileOfferAction(Z.GROUP),c=async(i,k,K)=>{try{console.log("[useFileShare] 开始上传加密文件:",i.name);const C=await oe.prepareFileForTransfer(i);if(a.value.set(C.id,0),!C.aesKey||!C.iv)throw new Error("文件加密失败：缺少 AES 密钥或 IV");const U={...C,file:i,userId:k,username:K,blobUrl:C.isInline?oe.createBlobUrl(i):void 0};n.value.push(U),s.set(C.id,i);const f=e.value.filter(x=>x.publicKey!==null);if(console.log("[useFileShare] 向",f.length,"个 peer 发送加密文件"),f.length===0){console.warn("[useFileShare] 没有在线的 peer，文件仅保存在本地"),a.value.set(C.id,100);return}for(const x of f)try{const I=await Y.encryptAESKey(C.aesKey,x.publicKey),P={id:C.id,fileName:C.name,fileSize:C.size,fileType:C.type,magnetURI:C.magnetURI,isInline:C.isInline,encryptedAESKey:Ut(I),iv:Ut(C.iv.buffer)};l(P,x.peerId),console.log("[useFileShare] 已向 peer 发送加密文件:",x.username)}catch(I){console.error("[useFileShare] 向 peer 发送失败:",x.username,I)}a.value.set(C.id,100),console.log("[useFileShare] 加密文件上传完成:",i.name)}catch(C){throw console.error("[useFileShare] 文件上传失败:",C),C}};u(async(i,k)=>{if(console.log("[useFileShare] 收到加密文件提供:",i.fileName,"来自:",k),n.value.find(C=>C.id===i.id)){console.log("[useFileShare] 文件已存在，跳过");return}if(!i.encryptedAESKey||!i.iv){console.error("[useFileShare] 文件缺少加密信息，无法接收");return}if(!t.value){console.error("[useFileShare] 本地私钥不可用，无法解密");return}try{console.log("[useFileShare] 开始解密 AES 密钥");const C=Lt(i.encryptedAESKey),U=await Y.decryptAESKey(C,t.value);console.log("[useFileShare] AES 密钥解密成功");const f=Lt(i.iv),x=new Uint8Array(f),P=e.value.find(m=>m.peerId===k)?.username||"远程用户",V={id:i.id,name:i.fileName,size:i.fileSize,type:i.fileType,magnetURI:i.magnetURI,isInline:i.isInline||!1,timestamp:Date.now(),userId:k,username:P,aesKey:U,iv:x};n.value.push(V),console.log("[useFileShare] 加密文件已添加到列表:",V.name),V.isInline&&V.magnetURI&&(console.log("[useFileShare] 自动下载并解密内联媒体:",V.name),w(V))}catch(C){console.error("[useFileShare] 处理加密文件失败:",C)}});const w=async i=>{try{if(console.log("[useFileShare] 开始自动下载加密内联媒体:",i.name),!i.aesKey||!i.iv){console.error("[useFileShare] 缺少解密密钥，无法下载");return}const k=await oe.downloadFileByMagnetURI(i.magnetURI,i.aesKey,i.iv,f=>{console.log("[useFileShare] 内联媒体下载进度:",f.toFixed(2)+"%")});console.log("[useFileShare] 下载并解密完成，获得 Blob:",k.size,"字节");const K=new Blob([k],{type:i.type}),C=oe.createBlobUrl(K);console.log("[useFileShare] 创建 Blob URL:",C);const U=n.value.findIndex(f=>f.id===i.id);U!==-1&&n.value[U]?(n.value[U].blobUrl=C,console.log("[useFileShare] 内联媒体自动下载并解密完成:",i.name)):console.error("[useFileShare] 找不到文件对象，无法更新 blobUrl")}catch(k){console.error("[useFileShare] 内联媒体自动下载失败:",k)}};return{sharedFiles:n,uploadProgress:a,uploadFile:c,downloadFile:async i=>{try{const k=n.value.find(U=>U.id===i);if(!k)throw new Error("文件不存在");console.log("[useFileShare] 开始下载文件:",k.name);const K=s.get(i);if(K){oe.downloadFile(K,K.name),console.log("[useFileShare] 本地文件下载完成");return}if(!k.magnetURI)throw new Error("文件 MagnetURI 不存在");if(!k.aesKey||!k.iv)throw new Error("文件缺少解密密钥");console.log("[useFileShare] 通过 P2P 下载并解密文件:",k.magnetURI),oe.updateDownloadProgress(i,0,"downloading");const C=await oe.downloadFileByMagnetURI(k.magnetURI,k.aesKey,k.iv,U=>{oe.updateDownloadProgress(i,U,"downloading")});oe.updateDownloadProgress(i,100,"completed"),oe.downloadFile(C,k.name),console.log("[useFileShare] P2P 文件下载完成")}catch(k){throw console.error("[useFileShare] 文件下载失败:",k),n.value.find(C=>C.id===i)&&oe.updateDownloadProgress(i,0,"error"),k}},getFileById:i=>n.value.find(k=>k.id===i),cleanup:()=>{n.value.forEach(i=>{i.blobUrl&&oe.revokeBlobUrl(i.blobUrl)}),n.value=[],a.value.clear(),s.clear()}}},ct=o=>{const e=String.fromCharCode(...new Uint8Array(o));return btoa(e)},dt=o=>{const e=atob(o),t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t.buffer},Xn=o=>{const e=D([]),t=D([]),n=D(""),a=D(""),s=D(!1),l=D(null),u=D(null);let c=null,w=null,S=null;const d=z(()=>c),y=jn(d);let i=null;const k=D([]),K=D(new Map),C=z(()=>t.value.filter(h=>h.isVerified).length),U=z(()=>t.value.filter(h=>h.verificationState===et.VERIFYING).length),f=z(()=>t.value.filter(h=>h.verificationState===et.UNVERIFIED).length),x=z(()=>t.value.length>0&&t.value.every(h=>h.isVerified)),I=async()=>{try{const h=await ue.getItem("privateKey"),p=await ue.getItem("publicKey"),R=await ue.getItem("userId");if(h&&p&&R)u.value=await Y.parseCryptoKey(h,"private"),l.value=await Y.parseCryptoKey(p,"public"),n.value=R;else{const E=await Y.generateKeyPair();u.value=E.privateKey,l.value=E.publicKey,n.value=st();const g=await Y.stringifyCryptoKey(E.privateKey),O=await Y.stringifyCryptoKey(E.publicKey);await ue.setItem("privateKey",g),await ue.setItem("publicKey",O),await ue.setItem("userId",n.value)}const N=await ue.getItem("username");a.value=N||Jn(n.value),N||await ue.setItem("username",a.value)}catch(h){console.error("密钥初始化失败:",h)}};let P=!1;const V=async()=>{if(console.log("[useRoom] 开始加入房间:",o),P){console.log("[useRoom] 正在加入房间中，忽略重复调用");return}P=!0;try{c&&(console.log("[useRoom] 检测到已存在的房间连接，先清理"),await b()),await I(),console.log("[useRoom] 密钥初始化完成, userId:",n.value),c=new Gn(o,{rtcConfig:Wn}),console.log("[useRoom] PeerRoom 创建完成"),u.value&&(c.setLocalPrivateKey(u.value),console.log("[useRoom] 本地私钥已设置到验证管理器"));const h=c.createMessageAction();w=h.sendMessage,h.onMessage(async E=>{try{if(E.encrypted&&E.encryptedAESKey&&E.iv&&u.value){console.log("[useRoom] 收到加密消息，开始解密");const g=dt(E.encryptedAESKey),O=await Y.decryptAESKey(g,u.value),B=dt(E.text),W=new Uint8Array(dt(E.iv)),q=await Y.decryptText(B,O,W);E.text=q,console.log("[useRoom] 消息解密成功")}e.value.push(E)}catch(g){console.error("[useRoom] 消息解密失败:",g),e.value.push({...E,text:"[加密消息解密失败]"})}});const p=c.createMetadataAction();S=p.sendMetadata,p.onMetadata(async(E,g)=>{console.log("[useRoom] 收到元数据来自:",g,E);try{const O=await Y.parseCryptoKey(E.publicKey,"public");console.log("[useRoom] 解析公钥成功:",g),c&&(c.registerPublicKey(g,O),console.log("[useRoom] 注册公钥成功:",g));const B=t.value.findIndex(q=>q.peerId===g),W={peerId:g,userId:E.userId,username:E.username,publicKey:O,verificationState:c?.getVerificationState(g),isVerified:c?.isVerified(g)};if(B>=0?t.value[B]=W:t.value.push(W),l.value&&u.value&&c){console.log("[useRoom] 开始启动验证:",g);try{await c.initiateVerification(g,O,u.value),console.log("[useRoom] 验证启动成功:",g),m(g)}catch(q){console.error("[useRoom] 启动验证失败:",q)}}}catch(O){console.error("[useRoom] 处理元数据失败:",O)}}),c.onPeerJoin(Ae.NEW_PEER,async E=>{if(console.log("[useRoom] 用户加入:",E),S&&l.value){console.log("[useRoom] 发送元数据给新用户:",E);const g=await Y.stringifyCryptoKey(l.value);S({userId:n.value,username:a.value,publicKey:g},E)}else console.warn("[useRoom] 无法发送元数据: sendMetadata或publicKey不可用")}),c&&(i=Qn(c,t,u),ie(i.sharedFiles,E=>{k.value=E},{deep:!0,immediate:!0}),ie(i.uploadProgress,E=>{K.value=E},{deep:!0,immediate:!0}),console.log("[useRoom] 文件共享功能已初始化（支持端到端加密）")),c.onPeerLeave(Ae.NEW_PEER,E=>{console.log("用户离开:",E),c&&c.removePeerVerification(E),t.value=t.value.filter(g=>g.peerId!==E)}),s.value=!0,y.initializeMediaListeners();const R=async()=>{if(c)try{const E=await c.getPeerConnectionTypes();t.value.forEach(g=>{g.connectionType=E[g.peerId],g.verificationState=c?.getVerificationState(g.peerId),g.isVerified=c?.isVerified(g.peerId)})}catch(E){console.error("更新连接类型失败:",E)}};setTimeout(R,2e3);const N=setInterval(R,1e4);tt(()=>{clearInterval(N)})}catch(h){if(console.error("[useRoom] 加入房间失败:",h),c){try{c.leave()}catch(p){console.error("[useRoom] 清理失败的房间连接时出错:",p)}c=null}throw h}finally{P=!1,console.log("[useRoom] joinRoom 完成，重置 isJoining 标志")}},m=h=>{if(!c)return;const p=t.value.findIndex(R=>R.peerId===h);if(p>=0){const R=t.value[p];R&&(R.verificationState=c.getVerificationState(h),R.isVerified=c.isVerified(h))}},L=async h=>{if(!c||!l.value||!u.value)throw new Error("房间未初始化或密钥不可用");const p=t.value.find(R=>R.peerId===h);if(!p||!p.publicKey)throw new Error("对方公钥不可用");try{await c.initiateVerification(h,p.publicKey,u.value),m(h)}catch(R){throw console.error("启动验证失败:",R),R}},T=h=>c?c.getVerificationState(h):et.UNVERIFIED,$=h=>c?c.isVerified(h):!1,H=async h=>{if(!w||!h.trim())return;const p=h.trim(),R=st(),N=Date.now(),E={id:R,userId:n.value,username:a.value,text:p,timestamp:N};e.value.push(E);const g=t.value.filter(O=>O.publicKey!==null);if(g.length===0){console.log("[useRoom] 没有在线的 peer，消息仅保存在本地");return}try{for(const O of g)try{const B=await Y.generateAESKey(),{encryptedData:W,iv:q}=await Y.encryptText(p,B),j=await Y.encryptAESKey(B,O.publicKey),Q={id:R,userId:n.value,username:a.value,text:ct(W),timestamp:N,encrypted:!0,encryptedAESKey:ct(j),iv:ct(q.buffer)};w(Q,O.peerId),console.log("[useRoom] 已向 peer 发送加密消息:",O.username)}catch(B){console.error("[useRoom] 向 peer 发送加密消息失败:",O.username,B)}console.log("[useRoom] 加密消息已发送给",g.length,"个 peer")}catch(O){console.error("[useRoom] 消息加密失败:",O)}},v=async h=>{if(h.trim()&&(a.value=h.trim(),await ue.setItem("username",a.value),S&&l.value)){const p=await Y.stringifyCryptoKey(l.value);S({userId:n.value,username:a.value,publicKey:p})}},b=async()=>{console.log("[useRoom] 开始离开房间");try{y.cleanup(),console.log("[useRoom] 媒体资源已清理")}catch(h){console.error("[useRoom] 清理媒体资源时出错:",h)}if(i)try{i.cleanup(),i=null,k.value=[],K.value=new Map,console.log("[useRoom] 文件共享资源已清理")}catch(h){console.error("[useRoom] 清理文件共享资源时出错:",h)}if(c){try{c.leave(),console.log("[useRoom] PeerRoom.leave() 已调用"),await new Promise(h=>setTimeout(h,100)),console.log("[useRoom] PeerRoom 已清理")}catch(h){console.error("[useRoom] 清理 PeerRoom 时出错:",h)}c=null}s.value=!1,t.value=[],e.value=[],w=null,S=null,console.log("[useRoom] 房间清理完成")},F=async h=>{if(!i)throw new Error("文件共享功能未初始化");try{await i.uploadFile(h,n.value,a.value),console.log("[useRoom] 文件发送成功:",h.name)}catch(p){throw console.error("[useRoom] 文件发送失败:",p),p}},_=async h=>{if(!i)throw new Error("文件共享功能未初始化");try{await i.downloadFile(h),console.log("[useRoom] 文件下载成功")}catch(p){throw console.error("[useRoom] 文件下载失败:",p),p}};return tt(()=>{b()}),{messages:e,peers:t,currentUserId:n,currentUsername:a,isConnected:s,verifiedPeersCount:C,verifyingPeersCount:U,unverifiedPeersCount:f,allPeersVerified:x,joinRoom:V,sendChatMessage:H,updateUsername:v,leaveRoom:b,startVerification:L,getVerificationState:T,isVerified:$,updatePeerVerificationState:m,media:y,sharedFiles:k,uploadProgress:K,sendFile:F,downloadFile:_}},Zn={key:0,class:"top-controls"},eo=["title"],to={key:0,class:"icon",viewBox:"0 0 24 24"},no={key:1,class:"icon",viewBox:"0 0 24 24"},oo=["title"],ao={key:0,class:"icon",viewBox:"0 0 24 24"},so={key:1,class:"icon",viewBox:"0 0 24 24"},ro=["title"],io={class:"main-display"},lo={key:0,class:"idle-state"},co={key:1,class:"audio-call"},uo={class:"avatar-container"},fo={class:"avatar-circle"},mo={class:"avatar-initials"},vo={class:"user-name"},yo={key:2,class:"video-call"},go={key:3,class:"screen-share"},po={key:4,class:"split-view"},ho={class:"split-panel"},So={class:"split-panel"},wo={key:1,class:"bottom-controls"},Eo=ge({__name:"MediaControls",props:{media:{},userName:{}},setup(o){const e=o,t=D(null),n=D(null),a=z(()=>zt(e.userName||"User")),s=z(()=>{const y=e.media.mediaState.value.isAudioEnabled,i=e.media.mediaState.value.isVideoEnabled,k=e.media.mediaState.value.isScreenSharing;return!y&&!i&&!k?"idle":i&&k?"video-screen":k?"screen":i?"video":y?"audio":"idle"}),l=z(()=>`mode-${s.value}`),u=z(()=>s.value!=="idle"),c=async()=>{try{e.media.mediaState.value.isAudioEnabled?e.media.stopAudioCall():await e.media.startAudioCall()}catch(y){console.error("音频切换失败:",y),alert("无法访问麦克风，请检查权限设置")}},w=async()=>{try{e.media.mediaState.value.isVideoEnabled?e.media.stopVideoCall():await e.media.startVideoCall()}catch(y){console.error("视频切换失败:",y),alert("无法访问摄像头/麦克风，请检查权限设置")}},S=async()=>{try{e.media.mediaState.value.isScreenSharing?e.media.stopScreenShare():await e.media.startScreenShare()}catch(y){console.error("屏幕共享切换失败:",y),alert("无法启动屏幕共享")}},d=()=>{alert("系统音频控制功能开发中...")};return ie(()=>e.media.localVideoStream.value,async y=>{await Ce(),y&&t.value&&(t.value.srcObject=y)}),ie(()=>e.media.localScreenStream.value,async y=>{await Ce(),y&&n.value&&(n.value.srcObject=y)}),(y,i)=>(M(),A("div",{class:G(["media-controls",l.value])},[u.value?(M(),A("div",Zn,[r("button",{onClick:c,class:G(["control-btn",{active:o.media.mediaState.value.isAudioEnabled}]),title:o.media.mediaState.value.isAudioEnabled?"关闭麦克风":"开启麦克风"},[o.media.mediaState.value.isAudioEnabled?(M(),A("svg",to,[...i[0]||(i[0]=[r("path",{d:"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"},null,-1),r("path",{d:"M19 10v2a7 7 0 0 1-14 0v-2"},null,-1),r("line",{x1:"12",y1:"19",x2:"12",y2:"23"},null,-1),r("line",{x1:"8",y1:"23",x2:"16",y2:"23"},null,-1)])])):(M(),A("svg",no,[...i[1]||(i[1]=[Ue('<line x1="1" y1="1" x2="23" y2="23" data-v-dcf89de9></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6" data-v-dcf89de9></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23" data-v-dcf89de9></path><line x1="12" y1="19" x2="12" y2="23" data-v-dcf89de9></line><line x1="8" y1="23" x2="16" y2="23" data-v-dcf89de9></line>',5)])]))],10,eo),r("button",{onClick:w,class:G(["control-btn",{active:o.media.mediaState.value.isVideoEnabled}]),title:o.media.mediaState.value.isVideoEnabled?"关闭摄像头":"开启摄像头"},[o.media.mediaState.value.isVideoEnabled?(M(),A("svg",ao,[...i[2]||(i[2]=[r("polygon",{points:"23 7 16 12 23 17 23 7"},null,-1),r("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"},null,-1)])])):(M(),A("svg",so,[...i[3]||(i[3]=[r("line",{x1:"1",y1:"1",x2:"23",y2:"23"},null,-1),r("path",{d:"M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10"},null,-1)])]))],10,oo),r("button",{onClick:S,class:G(["control-btn",{active:o.media.mediaState.value.isScreenSharing}]),title:o.media.mediaState.value.isScreenSharing?"停止屏幕共享":"开始屏幕共享"},[...i[4]||(i[4]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("rect",{x:"2",y:"3",width:"20",height:"14",rx:"2",ry:"2"}),r("line",{x1:"8",y1:"21",x2:"16",y2:"21"}),r("line",{x1:"12",y1:"17",x2:"12",y2:"21"})],-1)])],10,ro)])):ae("",!0),r("div",io,[s.value==="idle"?(M(),A("div",lo,[r("button",{onClick:c,class:"idle-btn",title:"音频通话"},[...i[5]||(i[5]=[Ue('<svg class="icon" viewBox="0 0 24 24" data-v-dcf89de9><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" data-v-dcf89de9></path><path d="M19 10v2a7 7 0 0 1-14 0v-2" data-v-dcf89de9></path><line x1="12" y1="19" x2="12" y2="23" data-v-dcf89de9></line><line x1="8" y1="23" x2="16" y2="23" data-v-dcf89de9></line></svg>',1)])]),r("button",{onClick:w,class:"idle-btn",title:"视频通话"},[...i[6]||(i[6]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("polygon",{points:"23 7 16 12 23 17 23 7"}),r("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})],-1)])]),r("button",{onClick:S,class:"idle-btn",title:"屏幕共享"},[...i[7]||(i[7]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("rect",{x:"2",y:"3",width:"20",height:"14",rx:"2",ry:"2"}),r("line",{x1:"8",y1:"21",x2:"16",y2:"21"}),r("line",{x1:"12",y1:"17",x2:"12",y2:"21"})],-1)])])])):s.value==="audio"?(M(),A("div",co,[r("div",uo,[r("div",fo,[r("div",mo,X(a.value),1)]),r("div",vo,X(o.userName),1),i[8]||(i[8]=r("div",{class:"call-status"},"音频通话中...",-1))])])):s.value==="video"?(M(),A("div",yo,[r("video",{ref_key:"localVideoRef",ref:t,autoplay:"",muted:"",playsinline:"",class:"video-stream fullscreen"},null,512),i[9]||(i[9]=r("div",{class:"video-overlay"},[r("div",{class:"user-label"},"你")],-1))])):s.value==="screen"?(M(),A("div",go,[r("video",{ref_key:"localScreenRef",ref:n,autoplay:"",muted:"",playsinline:"",class:"video-stream fullscreen"},null,512),i[10]||(i[10]=r("div",{class:"video-overlay"},[r("div",{class:"user-label"},"你的屏幕")],-1))])):s.value==="video-screen"?(M(),A("div",po,[r("div",ho,[r("video",{ref_key:"localVideoRef",ref:t,autoplay:"",muted:"",playsinline:"",class:"video-stream"},null,512),i[11]||(i[11]=r("div",{class:"panel-label"},"摄像头",-1))]),r("div",So,[r("video",{ref_key:"localScreenRef",ref:n,autoplay:"",muted:"",playsinline:"",class:"video-stream"},null,512),i[12]||(i[12]=r("div",{class:"panel-label"},"屏幕共享",-1))])])):ae("",!0)]),u.value?(M(),A("div",wo,[s.value==="audio"?(M(),A("button",{key:0,onClick:c,class:G(["main-control-btn","danger",{active:!o.media.mediaState.value.isAudioEnabled}])},[i[13]||(i[13]=r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("line",{x1:"1",y1:"1",x2:"23",y2:"23"}),r("path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"}),r("path",{d:"M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"})],-1)),r("span",null,X(o.media.mediaState.value.isAudioEnabled?"关闭麦克风":"开启麦克风"),1)],2)):s.value==="video"?(M(),A(ye,{key:1},[r("button",{onClick:c,class:G(["control-btn-bottom",{active:o.media.mediaState.value.isAudioEnabled}])},[...i[14]||(i[14]=[Ue('<svg class="icon" viewBox="0 0 24 24" data-v-dcf89de9><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" data-v-dcf89de9></path><path d="M19 10v2a7 7 0 0 1-14 0v-2" data-v-dcf89de9></path><line x1="12" y1="19" x2="12" y2="23" data-v-dcf89de9></line><line x1="8" y1="23" x2="16" y2="23" data-v-dcf89de9></line></svg>',1)])],2),r("button",{onClick:w,class:G(["control-btn-bottom","danger",{active:!o.media.mediaState.value.isVideoEnabled}])},[...i[15]||(i[15]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("line",{x1:"1",y1:"1",x2:"23",y2:"23"}),r("path",{d:"M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10"})],-1)])],2)],64)):s.value==="screen"?(M(),A(ye,{key:2},[r("button",{onClick:c,class:G(["control-btn-bottom",{active:o.media.mediaState.value.isAudioEnabled}])},[...i[16]||(i[16]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("path",{d:"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"}),r("path",{d:"M19 10v2a7 7 0 0 1-14 0v-2"})],-1)])],2),r("button",{onClick:S,class:G(["control-btn-bottom","danger"])},[...i[17]||(i[17]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("line",{x1:"1",y1:"1",x2:"23",y2:"23"}),r("rect",{x:"2",y:"3",width:"20",height:"14",rx:"2",ry:"2"})],-1)])])],64)):s.value==="video-screen"?(M(),A(ye,{key:3},[r("button",{onClick:c,class:G(["control-btn-bottom",{active:o.media.mediaState.value.isAudioEnabled}])},[...i[18]||(i[18]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("path",{d:"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"})],-1)])],2),r("button",{onClick:w,class:G(["control-btn-bottom",{active:o.media.mediaState.value.isVideoEnabled}])},[...i[19]||(i[19]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("polygon",{points:"23 7 16 12 23 17 23 7"}),r("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"})],-1)])],2),r("button",{onClick:d,class:G(["control-btn-bottom",{active:o.media.mediaState.value.isSystemAudioEnabled}]),title:"系统音频"},[...i[20]||(i[20]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"}),r("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"})],-1)])],2),r("button",{onClick:S,class:G(["control-btn-bottom","danger"])},[...i[21]||(i[21]=[r("svg",{class:"icon",viewBox:"0 0 24 24"},[r("line",{x1:"1",y1:"1",x2:"23",y2:"23"}),r("rect",{x:"2",y:"3",width:"20",height:"14",rx:"2",ry:"2"})],-1)])])],64)):ae("",!0)])):ae("",!0)],2))}}),pe=(o,e)=>{const t=o.__vccOpts||o;for(const[n,a]of e)t[n]=a;return t},bo=pe(Eo,[["__scopeId","data-v-dcf89de9"]]),Ro=["onMousedown"],Mo=["onMousedown"],To=ge({__name:"GridLayout",props:{rows:{default:2},columns:{default:2},gap:{default:8},cellSizes:{default:()=>[]},defaultColumnRatios:{default:()=>[]},defaultRowRatios:{default:()=>[]}},setup(o,{expose:e}){const t=o,n=D(null),a=D(0),s=D(0),l=z(()=>t.rows*t.columns),u=D([]),c=D([]),w=D(null),S=m=>{const L=Math.floor(m/t.columns),T=m%t.columns;return{row:L,col:T}},d=(m,L)=>m===void 0?L:typeof m=="number"?(m>0&&m<=1,m):typeof m=="string"?m.endsWith("%")?parseFloat(m)/100:(m.endsWith("px"),parseFloat(m)):L,y=()=>{t.defaultColumnRatios.length===t.columns?u.value=[...t.defaultColumnRatios]:u.value=Array(t.columns).fill(1/t.columns),t.defaultRowRatios.length===t.rows?c.value=[...t.defaultRowRatios]:c.value=Array(t.rows).fill(1/t.rows),t.cellSizes.length>0&&i()},i=()=>{const m=new Map,L=new Map;if(t.cellSizes.forEach(T=>{const{row:$,col:H}=S(T.cellIndex);if(T.width!==void 0){const v=d(T.width,1/t.columns),b=m.get(H);m.set(H,b?(b+v)/2:v)}if(T.height!==void 0){const v=d(T.height,1/t.rows),b=L.get($);L.set($,b?(b+v)/2:v)}}),m.size>0){const T=[...u.value];let $=0,H=0;m.forEach((F,_)=>{T[_]=F,$+=F,H++});const v=1-$,b=t.columns-H;if(b>0&&v>0){const F=v/b;for(let _=0;_<t.columns;_++)m.has(_)||(T[_]=F)}u.value=T}if(L.size>0){const T=[...c.value];let $=0,H=0;L.forEach((F,_)=>{T[_]=F,$+=F,H++});const v=1-$,b=t.rows-H;if(b>0&&v>0){const F=v/b;for(let _=0;_<t.rows;_++)L.has(_)||(T[_]=F)}c.value=T}},k=z(()=>u.value.map(m=>`${m*100}%`)),K=z(()=>c.value.map(m=>`${m*100}%`)),C=m=>{const L=(t.columns-1)*t.gap,T=a.value-L;let $=0;for(let H=0;H<=m;H++)$+=(u.value[H]||0)*T,H<m&&($+=t.gap);return $},U=m=>{const L=(t.rows-1)*t.gap,T=s.value-L;let $=0;for(let H=0;H<=m;H++)$+=(c.value[H]||0)*T,H<m&&($+=t.gap);return $},f=(m,L,T)=>{m.preventDefault(),w.value={type:L,index:T,startPos:L==="column"?m.clientX:m.clientY,startRatios:L==="column"?[...u.value]:[...c.value]},document.addEventListener("mousemove",x),document.addEventListener("mouseup",I),document.body.style.cursor=L==="column"?"col-resize":"row-resize",document.body.style.userSelect="none"},x=m=>{if(!w.value||!n.value)return;const{type:L,index:T,startPos:$,startRatios:H}=w.value;if(L==="column"){const v=m.clientX-$,b=(t.columns-1)*t.gap,F=a.value-b,_=v/F,h=(H[T]||0)+_,p=(H[T+1]||0)-_,R=.05;if(h>=R&&p>=R){const N=[...u.value];N[T]=h,N[T+1]=p,u.value=N}}else{const v=m.clientY-$,b=(t.rows-1)*t.gap,F=s.value-b,_=v/F,h=(H[T]||0)+_,p=(H[T+1]||0)-_,R=.05;if(h>=R&&p>=R){const N=[...c.value];N[T]=h,N[T+1]=p,c.value=N}}},I=()=>{w.value&&(w.value=null,document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",I),document.body.style.cursor="",document.body.style.userSelect="")},P=()=>{if(n.value){const m=n.value.getBoundingClientRect();a.value=m.width,s.value=m.height}};let V=null;return ie(()=>[t.rows,t.columns,t.cellSizes,t.defaultColumnRatios,t.defaultRowRatios],()=>{y()},{deep:!0}),it(()=>{y(),P(),n.value&&(V=new ResizeObserver(()=>{P()}),V.observe(n.value)),window.addEventListener("resize",P)}),tt(()=>{document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",I),window.removeEventListener("resize",P),V&&n.value&&(V.unobserve(n.value),V.disconnect())}),e({resetSizes:y,getColumnRatios:()=>[...u.value],getRowRatios:()=>[...c.value],setColumnRatios:m=>{m.length===t.columns&&(u.value=[...m])},setRowRatios:m=>{m.length===t.rows&&(c.value=[...m])}}),(m,L)=>(M(),A("div",{ref_key:"containerRef",ref:n,class:"grid-layout"},[r("div",{class:"grid-container",style:Ye({display:"grid",gridTemplateColumns:k.value.join(" "),gridTemplateRows:K.value.join(" "),gap:`${o.gap}px`,width:"100%",height:"100%"})},[(M(!0),A(ye,null,Le(l.value,T=>(M(),A("div",{key:`cell-${T}`,class:"grid-cell"},[Wt(m.$slots,`cell-${T-1}`,{},void 0)]))),128))],4),(M(!0),A(ye,null,Le(o.columns-1,T=>(M(),A("div",{key:`col-${T}`,class:"resize-handle resize-handle-vertical",style:Ye({left:`${C(T-1)}px`,height:"100%"}),onMousedown:$=>f($,"column",T-1)},null,44,Ro))),128)),(M(!0),A(ye,null,Le(o.rows-1,T=>(M(),A("div",{key:`row-${T}`,class:"resize-handle resize-handle-horizontal",style:Ye({top:`${U(T-1)}px`,width:"100%"}),onMousedown:$=>f($,"row",T-1)},null,44,Mo))),128))],512))}}),Ao=pe(To,[["__scopeId","data-v-3c723cc8"]]),Co={class:"avatar-container"},Po=["muted"],Io={key:1,class:"avatar-placeholder"},ko={key:1,class:"avatar-initials"},_o=["title"],xo={key:0,class:"icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Fo={key:1,class:"icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Uo={key:2,class:"screen-share-badge"},Lo={key:3,class:"icon-group"},Vo=["title"],Do={key:0,class:"icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},$o={key:1,class:"icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Oo=["title"],No={key:0,class:"icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Bo={key:1,class:"icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Ko=["title"],Ho=ge({__name:"UserGridCard",props:{username:{},userId:{},avatarUrl:{default:""},audioEnabled:{type:Boolean,default:!1},videoEnabled:{type:Boolean,default:!1},videoStream:{default:null},isScreenShare:{type:Boolean,default:!1},isLocal:{type:Boolean,default:!1},isExpanded:{type:Boolean,default:!1},maxNameLength:{default:12}},emits:["toggleAudio","toggleVideo","toggleExpand"],setup(o,{emit:e}){const t=o,n=e,a=D(null),s=()=>{t.isLocal||n("toggleAudio")},l=()=>{t.isLocal||n("toggleVideo")},u=()=>{n("toggleExpand")},c=z(()=>zt(t.username)),w=z(()=>t.username.length<=t.maxNameLength?t.username:t.username.slice(0,t.maxNameLength)+"...");return ie(()=>t.videoStream,async S=>{await Ce(),S&&a.value?(a.value.srcObject=S,console.log("[UserGridCard] 视频流已设置:",t.username,t.isScreenShare?"屏幕共享":"摄像头")):!S&&a.value&&(a.value.srcObject=null)},{immediate:!0}),(S,d)=>(M(),A("div",{class:G(["user-grid-card",{"is-screen-share":o.isScreenShare,"is-local":o.isLocal}])},[r("div",Co,[o.videoStream?(M(),A("video",{key:0,ref_key:"videoRef",ref:a,autoplay:"",muted:o.isLocal,playsinline:"",class:"video-stream"},null,8,Po)):(M(),A("div",Io,[o.avatarUrl?(M(),A("div",{key:0,class:"avatar-image",style:Ye({backgroundImage:`url(${o.avatarUrl})`})},null,4)):(M(),A("div",ko,X(c.value),1))])),r("button",{class:"expand-btn",title:o.isExpanded?"退出放大":"放大显示",onClick:u},[o.isExpanded?(M(),A("svg",Fo,[...d[1]||(d[1]=[r("path",{d:"M4 14h6v6M20 10h-6V4M10 10l-7 7M14 14l7-7"},null,-1)])])):(M(),A("svg",xo,[...d[0]||(d[0]=[r("path",{d:"M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"},null,-1)])]))],8,_o),o.isScreenShare?(M(),A("div",Uo,[...d[2]||(d[2]=[r("svg",{class:"icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[r("rect",{x:"2",y:"3",width:"20",height:"14",rx:"2",ry:"2"}),r("line",{x1:"8",y1:"21",x2:"16",y2:"21"}),r("line",{x1:"12",y1:"17",x2:"12",y2:"21"})],-1),r("span",null,"屏幕共享",-1)])])):ae("",!0),!o.isScreenShare&&!o.isLocal?(M(),A("div",Lo,[r("button",{class:G(["icon-badge",{"icon-active":o.audioEnabled,"icon-muted":!o.audioEnabled}]),title:o.audioEnabled?"点击静音":"点击取消静音",onClick:s},[o.audioEnabled?(M(),A("svg",Do,[...d[3]||(d[3]=[r("path",{d:"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"},null,-1),r("path",{d:"M19 10v2a7 7 0 0 1-14 0v-2"},null,-1),r("line",{x1:"12",y1:"19",x2:"12",y2:"23"},null,-1),r("line",{x1:"8",y1:"23",x2:"16",y2:"23"},null,-1)])])):(M(),A("svg",$o,[...d[4]||(d[4]=[Ue('<line x1="1" y1="1" x2="23" y2="23" data-v-15f1d5ce></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6" data-v-15f1d5ce></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23" data-v-15f1d5ce></path><line x1="12" y1="19" x2="12" y2="23" data-v-15f1d5ce></line><line x1="8" y1="23" x2="16" y2="23" data-v-15f1d5ce></line>',5)])]))],10,Vo),r("button",{class:G(["icon-badge",{"icon-active":o.videoEnabled,"icon-muted":!o.videoEnabled}]),title:o.videoEnabled?"点击关闭视频":"点击开启视频",onClick:l},[o.videoEnabled?(M(),A("svg",No,[...d[5]||(d[5]=[r("polygon",{points:"23 7 16 12 23 17 23 7"},null,-1),r("rect",{x:"1",y:"5",width:"15",height:"14",rx:"2",ry:"2"},null,-1)])])):(M(),A("svg",Bo,[...d[6]||(d[6]=[r("line",{x1:"1",y1:"1",x2:"23",y2:"23"},null,-1),r("path",{d:"M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10"},null,-1)])]))],10,Oo)])):ae("",!0)]),r("div",{class:"user-name",title:o.username},X(w.value),9,Ko)],2))}}),je=pe(Ho,[["__scopeId","data-v-15f1d5ce"]]),zo={class:"user-grid-container"},Go={class:"grid-title"},Jo=ge({__name:"UserGrid",props:{media:{},peers:{},currentUserId:{},currentUsername:{}},setup(o){const e=o,t=D(new Map),n=D(null),a=f=>(t.value.has(f)||t.value.set(f,{audioMuted:!1,videoHidden:!1}),t.value.get(f)),s=z(()=>e.media.mediaState.value),l=z(()=>e.media.localVideoStream.value),u=z(()=>e.media.localScreenStream.value),c=z(()=>e.media.remotePeerStreams.value),w=z(()=>{let f=1;return u.value&&f++,f+=e.peers.length,e.peers.forEach(x=>{i(x.peerId)&&f++}),f}),S=f=>a(f).audioMuted?!1:c.value.some(I=>I.peerId===f&&I.hasAudio&&I.type===J.MICROPHONE),d=f=>a(f).videoHidden?!1:c.value.some(I=>I.peerId===f&&I.hasVideo&&I.type===J.WEBCAM),y=f=>a(f).videoHidden?null:c.value.find(P=>P.peerId===f&&P.type===J.WEBCAM&&P.hasVideo)?.stream||null,i=f=>c.value.find(I=>I.peerId===f&&I.type===J.SCREEN_SHARE&&I.hasVideo)?.stream||null,k=f=>{const x=a(f);x.audioMuted=!x.audioMuted;const I=c.value.find(P=>P.peerId===f&&P.type===J.MICROPHONE);I&&I.stream&&I.stream.getAudioTracks().forEach(P=>{P.enabled=!x.audioMuted}),console.log(`[UserGrid] ${x.audioMuted?"静音":"取消静音"}用户:`,f)},K=f=>{const x=a(f);x.videoHidden=!x.videoHidden,console.log(`[UserGrid] ${x.videoHidden?"隐藏":"显示"}视频:`,f)},C=f=>{n.value===f?n.value=null:n.value=f,console.log("[UserGrid] 切换放大卡片:",f,n.value)},U=f=>n.value===null?"":n.value===f?"card-expanded":"card-collapsed";return(f,x)=>(M(),A("div",zo,[r("h3",Go,"在线成员 ("+X(w.value)+")",1),r("div",{class:G(["user-grid",{"has-expanded":n.value!==null}])},[ve(je,{class:G(U("local-main")),username:`${o.currentUsername} (你)`,"user-id":o.currentUserId,"audio-enabled":s.value.isAudioEnabled,"video-enabled":s.value.isVideoEnabled,"video-stream":l.value,"is-local":!0,"is-expanded":n.value==="local-main",onToggleExpand:x[0]||(x[0]=I=>C("local-main"))},null,8,["class","username","user-id","audio-enabled","video-enabled","video-stream","is-expanded"]),u.value?(M(),ut(je,{key:0,class:G(U("local-screen")),username:`${o.currentUsername} (你)`,"user-id":o.currentUserId,"audio-enabled":!1,"video-enabled":!1,"video-stream":u.value,"is-screen-share":!0,"is-local":!0,"is-expanded":n.value==="local-screen",onToggleExpand:x[1]||(x[1]=I=>C("local-screen"))},null,8,["class","username","user-id","video-stream","is-expanded"])):ae("",!0),(M(!0),A(ye,null,Le(o.peers,I=>(M(),A(ye,{key:I.peerId},[ve(je,{class:G(U(`peer-${I.peerId}-main`)),username:I.username,"user-id":I.userId,"audio-enabled":S(I.peerId),"video-enabled":d(I.peerId),"video-stream":y(I.peerId),"is-local":!1,"is-expanded":n.value===`peer-${I.peerId}-main`,onToggleAudio:P=>k(I.peerId),onToggleVideo:P=>K(I.peerId),onToggleExpand:P=>C(`peer-${I.peerId}-main`)},null,8,["class","username","user-id","audio-enabled","video-enabled","video-stream","is-expanded","onToggleAudio","onToggleVideo","onToggleExpand"]),i(I.peerId)?(M(),ut(je,{key:0,class:G(U(`peer-${I.peerId}-screen`)),username:I.username,"user-id":I.userId,"audio-enabled":!1,"video-enabled":!1,"video-stream":i(I.peerId),"is-screen-share":!0,"is-local":!1,"is-expanded":n.value===`peer-${I.peerId}-screen`,onToggleExpand:P=>C(`peer-${I.peerId}-screen`)},null,8,["class","username","user-id","video-stream","is-expanded","onToggleExpand"])):ae("",!0)],64))),128))],2)]))}}),Wo=pe(Jo,[["__scopeId","data-v-b9d0f117"]]),jo={class:"inline-media"},Yo={key:0,class:"inline-media-loading"},qo={key:1,class:"inline-media-error"},Qo={key:2,class:"inline-media-content"},Xo=["src","alt"],Zo=["src"],ea=["src"],ta={class:"inline-media-info"},na={class:"file-name"},oa={class:"file-size"},aa=ge({__name:"InlineMedia",props:{mediaUrl:{},fileName:{},fileType:{},fileSize:{},autoLoad:{type:Boolean,default:!0}},setup(o){const e=o,t=D(!0),n=D(!1),a=z(()=>oe.getMediaCategory(e.fileType)),s=z(()=>oe.formatFileSize(e.fileSize)),l=()=>{t.value=!1,n.value=!1},u=()=>{t.value=!1,n.value=!0,console.error("[InlineMedia] 媒体加载失败:",e.fileName)};return it(()=>{e.mediaUrl&&(t.value=!1)}),tt(()=>{}),(c,w)=>(M(),A("div",jo,[t.value?(M(),A("div",Yo,[...w[0]||(w[0]=[r("div",{class:"spinner"},null,-1),r("span",null,"加载中...",-1)])])):n.value?(M(),A("div",qo,[...w[1]||(w[1]=[r("span",null,"⚠️ 加载失败",-1)])])):(M(),A("div",Qo,[a.value==="image"&&o.mediaUrl?(M(),A("img",{key:0,src:o.mediaUrl,alt:o.fileName,class:"inline-image",onLoad:l,onError:u},null,40,Xo)):a.value==="audio"&&o.mediaUrl?(M(),A("audio",{key:1,src:o.mediaUrl,controls:"",class:"inline-audio",onLoadeddata:l,onError:u}," 您的浏览器不支持音频播放 ",40,Zo)):a.value==="video"&&o.mediaUrl?(M(),A("video",{key:2,src:o.mediaUrl,controls:"",class:"inline-video",onLoadeddata:l,onError:u}," 您的浏览器不支持视频播放 ",40,ea)):ae("",!0)])),r("div",ta,[r("span",na,X(o.fileName),1),r("span",oa,X(s.value),1)])]))}}),sa=pe(aa,[["__scopeId","data-v-6a521dea"]]),ra=["disabled","title"],ia={key:0,class:"download-progress"},la={class:"progress-ring",width:"24",height:"24"},ca=["stroke-dashoffset"],da={class:"progress-text"},ua={key:1,class:"download-icon"},fa=10,ma=ge({__name:"DownloadFileButton",props:{fileId:{},fileName:{},title:{default:"下载文件"}},emits:["download"],setup(o,{expose:e,emit:t}){const n=o,a=t,s=D(!1),l=D(0),u=2*Math.PI*fa,c=z(()=>{const d=l.value;return u-d/100*u}),w=z(()=>s.value?`下载中... ${Math.round(l.value)}%`:n.title||`下载 ${n.fileName}`),S=async()=>{if(!s.value)try{s.value=!0,l.value=0;const d=setInterval(()=>{l.value<90&&(l.value+=10)},200);a("download",n.fileId),await new Promise(y=>setTimeout(y,2e3)),clearInterval(d),l.value=100,setTimeout(()=>{s.value=!1,l.value=0},500)}catch(d){console.error("[DownloadFileButton] 下载失败:",d),s.value=!1,l.value=0}};return e({startDownload:S,updateProgress:d=>{l.value=d}}),(d,y)=>(M(),A("button",{class:G(["download-file-button",{downloading:s.value}]),disabled:s.value,onClick:S,title:w.value},[s.value?(M(),A("div",ia,[(M(),A("svg",la,[r("circle",{class:"progress-ring-circle","stroke-dasharray":u,"stroke-dashoffset":c.value,"stroke-width":"3",fill:"transparent",r:"10",cx:"12",cy:"12"},null,8,ca)])),r("span",da,X(Math.round(l.value))+"%",1)])):(M(),A("div",ua,[...y[0]||(y[0]=[r("span",null,"⬇️",-1),r("span",{class:"download-label"},"下载",-1)])]))],10,ra))}}),va=pe(ma,[["__scopeId","data-v-00783934"]]),ya={class:"message-panel"},ga={class:"message-username"},pa={class:"message-time"},ha={key:0,class:"message-content"},Sa={key:1,class:"message-file-content"},wa={key:1,class:"file-loading"},Ea={key:2,class:"file-info"},ba={class:"file-details"},Ra={class:"file-name"},Ma={class:"file-size"},Ta={class:"message-input"},Aa=["disabled"],Ca=["disabled"],Pa=["disabled"],Ia=ge({__name:"MessagePanel",props:{messages:{},sharedFiles:{},currentUserId:{},isConnected:{type:Boolean}},emits:["sendMessage","sendFile","downloadFile"],setup(o,{expose:e,emit:t}){const n=o,a=t,s=D(""),l=D(null),u=D(null),c=z(()=>{const C=n.messages.map(f=>({...f,type:"text"})),U=n.sharedFiles.map(f=>({id:f.id,type:"file",userId:f.userId,username:f.username,timestamp:f.timestamp,name:f.name,size:f.size,fileType:f.type,isInline:f.isInline,blobUrl:f.blobUrl}));return[...C,...U].sort((f,x)=>f.timestamp-x.timestamp)}),w=()=>{s.value.trim()&&(a("sendMessage",s.value),s.value="",K())},S=()=>{u.value?.click()},d=async C=>{const U=C.target,f=U.files;if(f&&f.length>0){console.log("[MessagePanel] 选中文件:",Array.from(f).map(x=>x.name));for(const x of Array.from(f))a("sendFile",x);U.value=""}},y=C=>{a("downloadFile",C)},i=C=>new Date(C).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),k=C=>{if(C===0)return"0 B";const U=1024,f=["B","KB","MB","GB"],x=Math.floor(Math.log(C)/Math.log(U));return`${parseFloat((C/Math.pow(U,x)).toFixed(2))} ${f[x]}`},K=()=>{Ce(()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)})};return ie(c,()=>{console.log("[MessagePanel] 消息更新，总数:",c.value.length),K()},{deep:!0}),e({scrollToBottom:K}),(C,U)=>(M(),A("div",ya,[r("div",{class:"messages",ref_key:"messagesContainer",ref:l},[(M(!0),A(ye,null,Le(c.value,f=>(M(),A("div",{key:f.id,class:G(["message",f.type==="file"?"message-file":"",f.userId===o.currentUserId?"message-own":"message-peer"])},[r("div",{class:G(["message-header",f.userId===o.currentUserId?"message-header-own":"message-header-peer"])},[r("span",ga,X(f.username),1),r("span",pa,X(i(f.timestamp)),1)],2),f.type==="text"?(M(),A("div",ha,X(f.text),1)):(M(),A("div",Sa,[f.isInline&&f.blobUrl?(M(),ut(sa,{key:0,"media-url":f.blobUrl,"file-name":f.name,"file-type":f.fileType,"file-size":f.size},null,8,["media-url","file-name","file-type","file-size"])):f.isInline&&!f.blobUrl?(M(),A("div",wa,[...U[1]||(U[1]=[r("div",{class:"spinner"},null,-1),r("div",{class:"loading-text"},"正在加载媒体...",-1)])])):(M(),A("div",Ea,[U[2]||(U[2]=r("div",{class:"file-icon"},"📄",-1)),r("div",ba,[r("div",Ra,X(f.name),1),r("div",Ma,X(k(f.size)),1)])])),ve(va,{"file-id":f.id,"file-name":f.name,onDownload:y},null,8,["file-id","file-name"])]))],2))),128))],512),r("div",Ta,[nt(r("input",{"onUpdate:modelValue":U[0]||(U[0]=f=>s.value=f),onKeyup:at(w,["enter"]),type:"text",placeholder:"输入消息... (按 Enter 发送)",disabled:!o.isConnected},null,40,Aa),[[ot,s.value]]),r("input",{ref_key:"fileInput",ref:u,type:"file",style:{display:"none"},onChange:d,multiple:""},null,544),r("button",{class:"btn-attachment",onClick:S,disabled:!o.isConnected,title:"发送文件"}," 📎 ",8,Ca),r("button",{onClick:w,disabled:!o.isConnected||!s.value.trim()}," 发送 ",8,Pa)])]))}}),ka=pe(Ia,[["__scopeId","data-v-df780d11"]]),_a="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Gt=()=>typeof window<"u"?window.location.hostname:"localhost",gt=()=>{const o=Gt(),e=en(o,_a);return console.log("[PublicRoom] 域名:",o,"-> 公共房间ID:",e),e},xa=o=>o===gt(),Fa=()=>Gt(),Ua={class:"chat-room"},La={class:"chat-header"},Va={class:"room-info"},Da=["title"],$a={class:"online-count"},Oa={class:"header-actions"},Na={key:0,class:"toast"},Ba={class:"dialog-tabs"},Ka={key:0,class:"tab-content"},Ha={key:1,class:"tab-content"},za=["disabled"],Ga={class:"dialog-actions"},Ja={class:"dialog-actions"},Wa=["disabled"],ja={class:"chat-content"},Ya=ge({__name:"ChatRoom",props:{roomId:{}},emits:["leave","switchRoom"],setup(o,{emit:e}){const t=o,n=e,{messages:a,peers:s,currentUserId:l,currentUsername:u,isConnected:c,joinRoom:w,sendChatMessage:S,updateUsername:d,leaveRoom:y,media:i,sharedFiles:k,sendFile:K,downloadFile:C}=Xn(t.roomId),U=D(!1),f=D(""),x=D(null),I=D(!1),P=D(!1),V=D("create"),m=D(""),L=D(null),T=z(()=>xa(t.roomId)),$=z(()=>Fa());it(()=>{console.log("[ChatRoom] 组件已挂载，加入房间"),w()}),jt(async()=>{console.log("[ChatRoom] 组件即将卸载，离开房间"),await y()});const H=E=>{S(E)},v=async E=>{try{await K(E)}catch(g){console.error("[ChatRoom] 文件发送失败:",g),alert("文件发送失败，请重试")}},b=async E=>{try{await C(E)}catch(g){console.error("[ChatRoom] 文件下载失败:",g),alert("文件下载失败，请重试")}},F=async()=>{try{await navigator.clipboard.writeText(t.roomId),I.value=!0,setTimeout(()=>{I.value=!1},2e3)}catch(E){console.error("复制失败:",E)}},_=async()=>{await y(),n("leave")},h=async()=>{const E=f.value.trim();if(E)try{await d(E),U.value=!1,f.value=""}catch(g){console.error("修改用户名失败:",g),alert("修改用户名失败，请重试")}},p=async()=>{const E=st();P.value=!1,await y(),n("switchRoom",E)},R=async()=>{const E=m.value.trim();E&&(P.value=!1,m.value="",await y(),n("switchRoom",E))},N=async()=>{const E=gt();await y(),n("switchRoom",E)};return ie(U,async E=>{E&&(f.value=u.value,await Ce(),x.value?.focus(),x.value?.select())}),ie(P,async E=>{E&&(V.value="create",m.value="")}),ie(V,async E=>{E==="join"&&(await Ce(),L.value?.focus())}),(E,g)=>(M(),A("div",Ua,[r("div",La,[r("h2",null,"🔐 "+X(T.value?"公共聊天室":"P2P 聊天室"),1),r("div",Va,[r("span",{class:"room-id",title:o.roomId},X(T.value?`${$.value} 公共房间`:`房间: ${o.roomId.slice(0,8)}...`),9,Da),r("span",$a,"在线: "+X(se(s).length+1),1),r("button",{class:"username-display",onClick:g[0]||(g[0]=O=>U.value=!0),title:"点击修改用户名"}," 👤 "+X(se(u)),1)]),r("div",Oa,[r("button",{class:"btn-icon",onClick:g[1]||(g[1]=O=>P.value=!0),title:"创建/加入房间"}," ➕ "),T.value?ae("",!0):(M(),A("button",{key:0,class:"btn-icon btn-public",onClick:N,title:"回到公共房间"}," 🏠 ")),r("button",{class:"btn-icon",onClick:F,title:"复制房间号"}," 📋 "),r("button",{class:"btn-icon btn-danger",onClick:_,title:"离开房间"}," 🚪 ")])]),ve(Yt,{name:"toast"},{default:Be(()=>[I.value?(M(),A("div",Na," ✅ 房间号已复制到剪贴板 ")):ae("",!0)]),_:1}),P.value?(M(),A("div",{key:0,class:"dialog-overlay",onClick:g[7]||(g[7]=O=>P.value=!1)},[r("div",{class:"dialog-content",onClick:g[6]||(g[6]=ht(()=>{},["stop"]))},[g[14]||(g[14]=r("h3",null,"创建或加入房间",-1)),r("div",Ba,[r("button",{class:G(["tab",{active:V.value==="create"}]),onClick:g[2]||(g[2]=O=>V.value="create")}," 创建新房间 ",2),r("button",{class:G(["tab",{active:V.value==="join"}]),onClick:g[3]||(g[3]=O=>V.value="join")}," 加入房间 ",2)]),V.value==="create"?(M(),A("div",Ka,[g[12]||(g[12]=r("p",{class:"hint"},"创建一个新的私密房间，只有知道房间号的人才能加入",-1)),r("button",{class:"btn-primary full-width",onClick:p}," 🎲 创建随机房间 ")])):(M(),A("div",Ha,[g[13]||(g[13]=r("p",{class:"hint"},"输入房间号加入已有的房间",-1)),nt(r("input",{"onUpdate:modelValue":g[4]||(g[4]=O=>m.value=O),type:"text",placeholder:"输入房间 ID",onKeyup:at(R,["enter"]),ref_key:"joinRoomInput",ref:L},null,544),[[ot,m.value]]),r("button",{class:"btn-primary full-width",onClick:R,disabled:!m.value.trim()}," 加入房间 ",8,za)])),r("div",Ga,[r("button",{class:"btn-secondary",onClick:g[5]||(g[5]=O=>P.value=!1)},"取消")])])])):ae("",!0),U.value?(M(),A("div",{key:1,class:"dialog-overlay",onClick:g[11]||(g[11]=O=>U.value=!1)},[r("div",{class:"dialog-content",onClick:g[10]||(g[10]=ht(()=>{},["stop"]))},[g[15]||(g[15]=r("h3",null,"修改用户名",-1)),nt(r("input",{"onUpdate:modelValue":g[8]||(g[8]=O=>f.value=O),type:"text",placeholder:"输入新用户名",maxlength:"20",onKeyup:at(h,["enter"]),ref_key:"usernameInput",ref:x},null,544),[[ot,f.value]]),r("div",Ja,[r("button",{class:"btn-secondary",onClick:g[9]||(g[9]=O=>U.value=!1)},"取消"),r("button",{class:"btn-primary",onClick:h,disabled:!f.value.trim()}," 确定 ",8,Wa)])])])):ae("",!0),r("div",ja,[ve(Ao,{rows:1,columns:3,gap:0,"default-column-ratios":[.2,.75,.05]},{"cell-0":Be(()=>[ve(Wo,{media:se(i),peers:se(s),"current-user-id":se(l),"current-username":se(u)},null,8,["media","peers","current-user-id","current-username"])]),"cell-1":Be(()=>[ve(ka,{messages:se(a),"shared-files":se(k),"current-user-id":se(l),"is-connected":se(c),onSendMessage:H,onSendFile:v,onDownloadFile:b},null,8,["messages","shared-files","current-user-id","is-connected"])]),"cell-2":Be(()=>[ve(bo,{media:se(i),"user-name":se(u)},null,8,["media","user-name"])]),_:1})])]))}}),qa=pe(Ya,[["__scopeId","data-v-5cc24e14"]]),Qa={class:"app"},Xa={key:0,class:"welcome"},Za={class:"welcome-card"},es={class:"actions"},ts={class:"join-room"},ns={key:1,class:"room-container"},os=ge({__name:"App",setup(o){const e=D(""),t=D(!1),n=D("");it(()=>{const d=new URLSearchParams(window.location.search).get("room");d?(e.value=d,t.value=!0):a()});const a=()=>{const S=gt();e.value=S,u(S),t.value=!0},s=()=>{const S=st();e.value=S,u(S),t.value=!0},l=()=>{n.value.trim()&&(e.value=n.value.trim(),u(e.value),t.value=!0)},u=S=>{const d=new URL(window.location.href);d.searchParams.set("room",S),window.history.pushState({},"",d.toString())},c=S=>{e.value=S,u(S),t.value=!0},w=()=>{t.value=!1,e.value="",window.history.pushState({},"",window.location.pathname),a()};return(S,d)=>(M(),A("div",Qa,[t.value?(M(),A("div",ns,[ve(qa,{roomId:e.value,onLeave:w,onSwitchRoom:c},null,8,["roomId"])])):(M(),A("div",Xa,[r("div",Za,[d[2]||(d[2]=Ue('<h1>🔐 P2P 加密聊天</h1><p class="subtitle">端到端加密 · 去中心化 · 零服务器存储</p><div class="features"><div class="feature"><span class="icon">🔒</span><div><h3>端到端加密</h3><p>消息仅在您和对方浏览器中存在</p></div></div><div class="feature"><span class="icon">🌐</span><div><h3>点对点直连</h3><p>无需中心服务器，直接 P2P 连接</p></div></div><div class="feature"><span class="icon">⚡</span><div><h3>即时通讯</h3><p>基于 WebRTC 的实时通信</p></div></div></div>',3)),r("div",es,[r("button",{class:"btn btn-primary",onClick:s}," 创建新房间 "),d[1]||(d[1]=r("div",{class:"divider"},"或",-1)),r("div",ts,[nt(r("input",{"onUpdate:modelValue":d[0]||(d[0]=y=>n.value=y),onKeyup:at(l,["enter"]),type:"text",placeholder:"输入房间 ID"},null,544),[[ot,n.value]]),r("button",{class:"btn btn-secondary",onClick:l}," 加入房间 ")])]),d[3]||(d[3]=r("div",{class:"tech-stack"},[r("p",null,"技术栈: Vue3 + TypeScript + Trystero + WebRTC")],-1))])]))]))}});qt(os).mount("#app");
